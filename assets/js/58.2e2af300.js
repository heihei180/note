(window.webpackJsonp=window.webpackJsonp||[]).push([[58],{561:function(s,t,a){"use strict";a.r(t);var e=a(27),n=Object(e.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("blockquote",[t("p",[s._v("思考一个问题，既然弄清楚了服务端是如何接收网络请求，并且他是如果根据请求类型去匹配消息处理器的，那么生产者生产消息的时候，他是如何具体处理这个消息的呢？是使用那个处理器，哪个线程池来处理这个消息的？")]),s._v(" "),t("p",[s._v("具体的处理流程是什么？")])]),s._v(" "),t("h1",{attrs:{id:"哪个处理器来处理生产消息的请求"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#哪个处理器来处理生产消息的请求"}},[s._v("#")]),s._v(" 哪个处理器来处理生产消息的请求")]),s._v(" "),t("h2",{attrs:{id:"_1-确定消息类型"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-确定消息类型"}},[s._v("#")]),s._v(" 1. 确定消息类型")]),s._v(" "),t("p",[s._v("根据生产者发送的消息类型来确定生产者客户端发送的消息的类型是什么？")]),s._v(" "),t("p",[s._v("所以需要追踪源码来确认。")]),s._v(" "),t("p",[s._v("堆栈")]),s._v(" "),t("div",{staticClass:"language-text extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("org.apache.rocketmq.client.producer.DefaultMQProducer#send(org.apache.rocketmq.common.message.Message)\n\torg.apache.rocketmq.client.impl.producer.DefaultMQProducerImpl#send(org.apache.rocketmq.common.message.Message)\n\t\torg.apache.rocketmq.client.impl.producer.DefaultMQProducerImpl#send(org.apache.rocketmq.common.message.Message, long)\n\t\t\torg.apache.rocketmq.client.impl.producer.DefaultMQProducerImpl#sendDefaultImpl\n\t\t\t\torg.apache.rocketmq.client.impl.producer.DefaultMQProducerImpl#sendKernelImpl\n\t\t\t\t\torg.apache.rocketmq.client.impl.MQClientAPIImpl#sendMessage\n\t\t\t\t\t\torg.apache.rocketmq.client.impl.MQClientAPIImpl#sendMessage\n")])])]),t("div",{staticClass:"language-java extra-class"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[s._v("\n                request "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("RemotingCommand")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("createRequestCommand")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("msg "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("instanceof")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("MessageBatch")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("?")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("RequestCode")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token constant"}},[s._v("SEND_BATCH_MESSAGE")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("RequestCode")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token constant"}},[s._v("SEND_MESSAGE_V2")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" requestHeaderV2"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n           \n")])])]),t("p",[s._v("可见，如果是批量消息 "),t("code",[s._v("MessageBatch")]),s._v(" ，消息类型是："),t("code",[s._v("RequestCode.SEND_BATCH_MESSAGE")])]),s._v(" "),t("p",[s._v("否则就是："),t("code",[s._v("RequestCode.SEND_MESSAGE_V2")]),s._v("  code=310")]),s._v(" "),t("h2",{attrs:{id:"_2-确认处理消息的处理器是哪个"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-确认处理消息的处理器是哪个"}},[s._v("#")]),s._v(" 2. 确认处理消息的处理器是哪个？")]),s._v(" "),t("p",[s._v("broker 获取处理器的位置：")]),s._v(" "),t("p",[t("strong",[s._v("org.apache.rocketmq.remoting.netty.NettyRemotingAbstract#processRequestCommand")])]),s._v(" "),t("p",[s._v("在broker获取处理器的位置打上条件断点，可以看到：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://gitee.com/gq2/img_repo2/raw/master/img/image-20240317141949087.png",alt:"image-20240317141949087"}})]),s._v(" "),t("p",[t("img",{attrs:{src:"https://gitee.com/gq2/img_repo2/raw/master/img/image-20240317141720507.png",alt:"xxx"}})]),s._v(" "),t("p",[s._v("code 310 对应的处理器是 "),t("strong",[s._v("SendMessageProcessor")])]),s._v(" "),t("h2",{attrs:{id:"_3-sendmessageprocessor-如何处理请求的"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-sendmessageprocessor-如何处理请求的"}},[s._v("#")]),s._v(" 3. SendMessageProcessor 如何处理请求的？")]),s._v(" "),t("p",[s._v("SendMessageProcessor的类图")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://gitee.com/gq2/img_repo2/raw/master/img/image-20240317142301835.png",alt:"image-20240317142301835"}})]),s._v(" "),t("p",[s._v("broker选择处理器是异步还是同步处理：")]),s._v(" "),t("div",{staticClass:"language-java extra-class"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[s._v("                        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("pair"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("getObject1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("instanceof")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("AsyncNettyRequestProcessor")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                            "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("AsyncNettyRequestProcessor")]),s._v(" processor "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("AsyncNettyRequestProcessor")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("pair"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("getObject1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                            processor"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("asyncProcessRequest")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("ctx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" cmd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" callback"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                            "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("NettyRequestProcessor")]),s._v(" processor "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" pair"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("getObject1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                            "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("RemotingCommand")]),s._v(" response "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" processor"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("processRequest")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("ctx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" cmd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                            callback"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("callback")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("response"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])])]),t("p",[s._v("根据上面类继承图可以看到，"),t("strong",[s._v("SendMessageProcessor")]),s._v(" 继承了 "),t("strong",[s._v("AsyncNettyRequestProcessor")]),s._v(" ，因此他是异步处理的。")]),s._v(" "),t("h2",{attrs:{id:"_4-sendmessageprocessor异步处理"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-sendmessageprocessor异步处理"}},[s._v("#")]),s._v(" 4. SendMessageProcessor异步处理")]),s._v(" "),t("div",{staticClass:"language-java extra-class"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[s._v("    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("asyncProcessRequest")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ChannelHandlerContext")]),s._v(" ctx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("RemotingCommand")]),s._v(" request"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("RemotingResponseCallback")]),s._v(" responseCallback"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("throws")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Exception")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("asyncProcessRequest")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("ctx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" request"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("thenAcceptAsync")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("responseCallback"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("::")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("callback")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("this")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("brokerController"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("getSendMessageExecutor")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])])]),t("p",[s._v("上面代码是SendMessageProcessor的处理函数，可以看出他进行了异步任务的编排")]),s._v(" "),t("ul",[t("li",[s._v("先进行"),t("code",[s._v("asyncProcessRequest")]),s._v(" 处理业务逻辑")]),s._v(" "),t("li",[s._v("然后"),t("code",[s._v("thenAcceptAsync(responseCallback::callback, this.brokerController.getSendMessageExecutor())")]),s._v("在线程池中执行回调函数")])]),s._v(" "),t("h3",{attrs:{id:"_4-1-处理逻辑"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-1-处理逻辑"}},[s._v("#")]),s._v(" 4.1 处理逻辑")]),s._v(" "),t("blockquote",[t("p",[s._v("比较复杂")])]),s._v(" "),t("h4",{attrs:{id:"_4-1-1-解析请求头"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-1-1-解析请求头"}},[s._v("#")]),s._v(" 4.1.1 解析请求头")]),s._v(" "),t("p",[s._v("org.apache.rocketmq.broker.processor.AbstractSendMessageProcessor#parseRequestHeader")]),s._v(" "),t("div",{staticClass:"language-java extra-class"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("SendMessageRequestHeader")]),s._v(" requestHeader "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("parseRequestHeader")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("request"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])]),t("h4",{attrs:{id:"_4-1-2-前置拦截"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-1-2-前置拦截"}},[s._v("#")]),s._v(" 4.1.2 前置拦截")]),s._v(" "),t("div",{staticClass:"language-java extra-class"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("this")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("executeSendMessageHookBefore")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("ctx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" request"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" mqtraceContext"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])]),t("h4",{attrs:{id:"_4-1-3-执行实际逻辑"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-1-3-执行实际逻辑"}},[s._v("#")]),s._v(" 4.1.3 执行实际逻辑")]),s._v(" "),t("p",[s._v("批量消息：")]),s._v(" "),t("div",{staticClass:"language-java extra-class"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("this")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("asyncSendBatchMessage")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("ctx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" request"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" mqtraceContext"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" requestHeader"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])]),t("p",[s._v("非批量消息：")]),s._v(" "),t("div",{staticClass:"language-java extra-class"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("this")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("asyncSendMessage")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("ctx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" request"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" mqtraceContext"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" requestHeader"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])]),t("h2",{attrs:{id:"_5-非批量消息的处理"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-非批量消息的处理"}},[s._v("#")]),s._v(" 5. 非批量消息的处理")]),s._v(" "),t("p",[s._v("org.apache.rocketmq.broker.processor.SendMessageProcessor#asyncSendMessage")]),s._v(" "),t("h3",{attrs:{id:"_5-1-将消息转换成内部消息格式-messageextbrokerinner"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-1-将消息转换成内部消息格式-messageextbrokerinner"}},[s._v("#")]),s._v(" 5.1 将消息转换成内部消息格式：MessageExtBrokerInner")]),s._v(" "),t("blockquote",[t("p",[s._v("转换过程没必要写了吧")])]),s._v(" "),t("h3",{attrs:{id:"_5-2-是否死信或者延迟消息"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-2-是否死信或者延迟消息"}},[s._v("#")]),s._v(" 5.2 是否死信或者延迟消息？")]),s._v(" "),t("p",[s._v("是的话就直接处理，然后结束，不是的话就继续往下执行。。。")]),s._v(" "),t("p",[s._v("TODO: 等待以后在看这个")]),s._v(" "),t("h3",{attrs:{id:"_5-3-是否事务消息-以及事务消息的处理"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-3-是否事务消息-以及事务消息的处理"}},[s._v("#")]),s._v(" 5.3 是否事务消息？以及事务消息的处理")]),s._v(" "),t("p",[s._v("事务消息的处理见：this.brokerController.getTransactionalMessageService().asyncPrepareMessage(msgInner);")]),s._v(" "),t("h3",{attrs:{id:"_5-4-普通消息的处理"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-4-普通消息的处理"}},[s._v("#")]),s._v(" 5.4 普通消息的处理")]),s._v(" "),t("p",[s._v("见代码：this.brokerController.getMessageStore().asyncPutMessage(msgInner)")]),s._v(" "),t("p",[s._v("因为我们的消息是普通消息，因此肯定走的是普通消息流程")]),s._v(" "),t("p",[s._v("即通过DefaultMessageStore将消息存储到commitLog中，下面再说如何存储消息")]),s._v(" "),t("h2",{attrs:{id:"_6-消息存储"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_6-消息存储"}},[s._v("#")]),s._v(" 6. 消息存储")]),s._v(" "),t("p",[s._v("org.apache.rocketmq.store.DefaultMessageStore#asyncPutMessage")]),s._v(" "),t("p",[s._v("defaultMessageStore也是委托commitLog对象处理消息的追加")]),s._v(" "),t("p",[s._v("即：this.commitLog.asyncPutMessage(msg);")]),s._v(" "),t("h3",{attrs:{id:"_6-1-commitlog-对消息的存储"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_6-1-commitlog-对消息的存储"}},[s._v("#")]),s._v(" 6.1 commitLog 对消息的存储")]),s._v(" "),t("p",[s._v("org.apache.rocketmq.store.CommitLog#asyncPutMessage")]),s._v(" "),t("h4",{attrs:{id:"_6-1-1-写文件"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_6-1-1-写文件"}},[s._v("#")]),s._v(" 6.1.1 写文件")]),s._v(" "),t("ol",[t("li",[s._v("先加写锁")]),s._v(" "),t("li",[s._v("获取最新的mapFile")]),s._v(" "),t("li",[s._v("如果mapedFile是空的就创建一个新的文件，如果mapedFile满了就在创建一个文件")]),s._v(" "),t("li",[s._v("将消息追加到mapedFile上")])]),s._v(" "),t("h4",{attrs:{id:"_6-1-2-mapedfile-消息追加"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_6-1-2-mapedfile-消息追加"}},[s._v("#")]),s._v(" 6.1.2  mapedFile 消息追加")]),s._v(" "),t("div",{staticClass:"language-java extra-class"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[t("span",{pre:!0,attrs:{class:"token class-name"}},[t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("org"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("apache"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("rocketmq"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("store"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),s._v("MappedFile")]),s._v("#"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("appendMessage")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("org"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("apache"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("rocketmq"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("store"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),s._v("MessageExtBrokerInner")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("org"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("apache"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("rocketmq"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("store"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),s._v("AppendMessageCallback")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("org"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("apache"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("rocketmq"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("store"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),s._v("CommitLog"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("PutMessageContext")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])])]),t("div",{staticClass:"language-text extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("org.apache.rocketmq.store.MappedFile#appendMessagesInner\n")])])]),t("div",{staticClass:"language-java extra-class"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("AppendMessageResult")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("appendMessagesInner")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("final")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("MessageExt")]),s._v(" messageExt"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("final")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("AppendMessageCallback")]),s._v(" cb"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                                                   "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("PutMessageContext")]),s._v(" putMessageContext"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 获取 mappedFile的buffer对象、")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ByteBuffer")]),s._v(" byteBuffer "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" writeBuffer "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("null")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("?")]),s._v(" writeBuffer"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("slice")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("this")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("mappedByteBuffer"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("slice")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 位置标记")]),s._v("\n            byteBuffer"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("position")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("currentPos"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 普通消息")]),s._v("\n             "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("AppendMessageResult")]),s._v("   result "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" cb"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("doAppend")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("this")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("getFileFromOffset")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" byteBuffer"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("this")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("fileSize "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" currentPos"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("MessageExtBrokerInner")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" messageExt"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" putMessageContext"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" result"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])])]),t("p",[s._v("可见，"),t("strong",[s._v("mappedFile的追加函数 实际追加逻辑委托给了 cb 对象")]),s._v("，通过代码回溯，知道cb 是："),t("code",[s._v("DefaultAppendMessageCallback")])]),s._v(" "),t("p",[s._v("因此，需要想要知道消息是如何写入到了mappedFile中，需要看 "),t("code",[s._v("CommitLog.DefaultAppendMessageCallback#doAppend()")])]),s._v(" "),t("p",[s._v("将消息写入了 MappedByteBuffer 中，等待 page cache 刷新 或者 force 才会将数据写入到磁盘中。")])])}),[],!1,null,null,null);t.default=n.exports}}]);