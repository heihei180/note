(window.webpackJsonp=window.webpackJsonp||[]).push([[54],{557:function(t,a,s){"use strict";s.r(a);var e=s(27),r=Object(e.a)({},(function(){var t=this,a=t._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"_1-启动入口"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-启动入口"}},[t._v("#")]),t._v(" 1. 启动入口")]),t._v(" "),a("p",[t._v("org.apache.rocketmq.broker.BrokerStartup#main")]),t._v(" "),a("p",[t._v("执行main函数之后，创建控制器")]),t._v(" "),a("p",[t._v("org.apache.rocketmq.broker.BrokerStartup#createBrokerController")]),t._v(" "),a("h2",{attrs:{id:"_1-1-brokercontroller介绍"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-brokercontroller介绍"}},[t._v("#")]),t._v(" 1.1 brokerController介绍")]),t._v(" "),a("p",[t._v("broker控制器，就是broker核心管理组件，")]),t._v(" "),a("p",[t._v("包含了几个核心配置：")]),t._v(" "),a("ul",[a("li",[a("p",[t._v("BrokerConfig: broker基础配置")])]),t._v(" "),a("li",[a("p",[t._v("NettyServerConfig：nettyserver的配置")])]),t._v(" "),a("li",[a("p",[t._v("NettyClientConfig")])]),t._v(" "),a("li",[a("p",[t._v("MessageStoreConfig： "),a("RouterLink",{attrs:{to:"/Java/RocketMQ/brokerController组件介绍/MessageStoreConfig.html"}},[t._v("消息存储配置")])],1)]),t._v(" "),a("li",[a("p",[t._v("RebalanceLockManager： "),a("RouterLink",{attrs:{to:"/Java/RocketMQ/brokerController组件介绍/RebalanceLockManager.html"}},[t._v("消费者客户端重平衡时候的绑定关系管理")])],1)]),t._v(" "),a("li",[a("p",[t._v("ConsumerOffsetManager：   "),a("RouterLink",{attrs:{to:"/Java/RocketMQ/brokerController组件介绍/ConsumerOffsetManager.html"}},[t._v("消费偏移管理器")])],1)]),t._v(" "),a("li",[a("p",[t._v("TopicConfigManager：  "),a("RouterLink",{attrs:{to:"/Java/RocketMQ/brokerController组件介绍/TopicConfigManager.html"}},[t._v("topic管理器 ")])],1)]),t._v(" "),a("li",[a("p",[t._v("PullMessageProcessor：消息拉取处理器")])]),t._v(" "),a("li",[a("p",[t._v("PullRequestHoldService")])]),t._v(" "),a("li",[a("p",[t._v("NotifyMessageArrivingListener：消息到达通知器")])]),t._v(" "),a("li",[a("p",[t._v("DefaultConsumerIdsChangeListener：没看懂干啥的、")])]),t._v(" "),a("li",[a("p",[t._v("ConsumerManager：消费者管理器===具体作用不知道，")])]),t._v(" "),a("li",[a("p",[t._v("ConsumerFilterManager：这个肯定是管理消费者的过滤器的")])]),t._v(" "),a("li",[a("p",[t._v("ProducerManager：生产者管理 ,详细介绍： "),a("RouterLink",{attrs:{to:"/Java/RocketMQ/brokerController组件介绍/ProducerManager介绍.html"}},[t._v("ProducerManager介绍")])],1)]),t._v(" "),a("li",[a("p",[t._v("ClientHousekeepingService：管理客户端是否掉线吧。")])]),t._v(" "),a("li",[a("p",[t._v("Broker2Client")])]),t._v(" "),a("li",[a("p",[t._v("SubscriptionGroupManager：订阅组")])]),t._v(" "),a("li",[a("p",[t._v("BrokerOuterAPI：broker外部api")])]),t._v(" "),a("li",[a("p",[t._v("FilterServerManager：")])]),t._v(" "),a("li",[a("p",[t._v("SlaveSynchronize：salve同步")])]),t._v(" "),a("li",[a("p",[t._v("BrokerStatsManager：broker状态管理")])]),t._v(" "),a("li",[a("p",[t._v("BrokerFastFailure：")])]),t._v(" "),a("li",[a("p",[t._v("Configuration：")])])]),t._v(" "),a("h2",{attrs:{id:"_1-2-创建和初始化brokercontroller"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-创建和初始化brokercontroller"}},[t._v("#")]),t._v(" 1.2 创建和初始化brokerController")]),t._v(" "),a("h3",{attrs:{id:"_1-加载本地配置文件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-加载本地配置文件"}},[t._v("#")]),t._v(" 1. 加载本地配置文件")]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// topic配置")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("boolean")]),t._v(" result "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("topicConfigManager"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("load")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 消费偏移")]),t._v("\nresult "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" result "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("consumerOffsetManager"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("load")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 订阅关系")]),t._v("\nresult "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" result "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("subscriptionGroupManager"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("load")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 消费者的filter")]),t._v("\nresult "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" result "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("consumerFilterManager"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("load")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("h3",{attrs:{id:"_2-defaultmessagestore消息存储对象初始化"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-defaultmessagestore消息存储对象初始化"}},[t._v("#")]),t._v(" 2.DefaultMessageStore消息存储对象初始化")]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/// 创建默认的存储对象")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 使用几个 commitLog， index reput 之类的 类协调底层的存储逻辑、")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("messageStore "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("DefaultMessageStore")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("messageStoreConfig"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("brokerStatsManager"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("messageArrivingListener"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("brokerConfig"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[a("em",[a("strong",[t._v("DefaultMessageStore")])]),t._v("：")]),t._v(" "),a("blockquote",[a("p",[t._v("默认的消息存储管理组件")]),t._v(" "),a("p",[t._v("rocketMq的存储核心组件，可以说是最重要的组件，没有之一，rmq 主要功能就是网络，存储。")])]),t._v(" "),a("p",[a("RouterLink",{attrs:{to:"/Java/RocketMQ/brokerController组件介绍/DefaultMessageStore.html"}},[t._v("消息存储管理组件DefaultMessageStore")])],1),t._v(" "),a("h3",{attrs:{id:"_3-dledgerrolechangehandler-支持"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-dledgerrolechangehandler-支持"}},[t._v("#")]),t._v(" 3. DLedgerRoleChangeHandler 支持")]),t._v(" "),a("blockquote",[a("p",[t._v("这个新特性我没有接触过，可以了解一下。")])]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("messageStoreConfig"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("isEnableDLegerCommitLog")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("DLedgerRoleChangeHandler")]),t._v(" roleChangeHandler "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("DLedgerRoleChangeHandler")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("DefaultMessageStore")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" messageStore"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("DLedgerCommitLog")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("DefaultMessageStore")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" messageStore"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getCommitLog")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getdLedgerServer")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getdLedgerLeaderElector")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("addRoleChangeHandler")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("roleChangeHandler"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("h3",{attrs:{id:"_4-拦截器的添加"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-拦截器的添加"}},[t._v("#")]),t._v(" 4. 拦截器的添加")]),t._v(" "),a("blockquote",[a("p",[t._v("rmq接收到消息之后，要进行一系列的构建索引，分发到不同的messageQueue之类的操作，就是通过 reput 线程做的，他好像就是一个拦截器，rmq收到消息后会执行 这里添加的拦截器，可以关注下，有助于了解rmq的消息转发流程，但是不是太难也不是高级的技术。因此知道即可。")])]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 添加消息分发的过滤器。 这个默认的 是 支持 标签过滤的， 即rocket消费者 可以在订阅的时候传递表达式，")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 这里就是计算消息和那个表达式的match关系的，match的发给消费者，不match的不发给消费者")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// todo: 每条消息都要经过所有的这些分发器，可以用它来分发消息，同样，也可以用它来过滤消息，或者构建索引")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("messageStore"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getDispatcherList")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("addFirst")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("CommitLogDispatcherCalcBitMap")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("brokerConfig"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("consumerFilterManager"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("其实为了佐证我上面的猜想，可以去messageStore的类中去看是不是添加了默认的消息拦截器")]),t._v(" "),a("p",[t._v("org.apache.rocketmq.store.DefaultMessageStore#DefaultMessageStore")]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("dispatcherList "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("LinkedList")]),a("span",{pre:!0,attrs:{class:"token generics"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("dispatcherList"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("addLast")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("CommitLogDispatcherBuildConsumeQueue")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("dispatcherList"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("addLast")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("CommitLogDispatcherBuildIndex")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("可以看到，添加了两个默认的消息拦截器，构建consumerQueue和索引，messageQueue不是，可以后续看下messageQueue中的消息是如何构建的，我现在忘了，记不清了。")]),t._v(" "),a("h3",{attrs:{id:"_5-messagestore-加载commitlog-文件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5-messagestore-加载commitlog-文件"}},[t._v("#")]),t._v(" 5. messageStore 加载commitLog 文件")]),t._v(" "),a("p",[t._v("这一步会加载commitLog，index 之类的本地文件，将磁盘文件和本地内存建立内存映射关系")]),t._v(" "),a("p",[t._v("org.apache.rocketmq.store.DefaultMessageStore#load")]),t._v(" "),a("p",[t._v("即，作用是保证本地磁盘文件的完整性。")]),t._v(" "),a("h3",{attrs:{id:"_6-网络相关组件的初始化"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-网络相关组件的初始化"}},[t._v("#")]),t._v(" 6. 网络相关组件的初始化")]),t._v(" "),a("ol",[a("li",[t._v("."),a("strong",[t._v("remotingServer")]),t._v(" ：提供web服务的服务器")]),t._v(" "),a("li",[t._v(".fastRemotingServer：和上面一样，但是不知道是什么意思")])]),t._v(" "),a("h3",{attrs:{id:"_7-启动相关的线程池"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_7-启动相关的线程池"}},[t._v("#")]),t._v(" 7. 启动相关的线程池")]),t._v(" "),a("p",[t._v("建立了很多的线程池，不知道有啥用？这就是线程隔离？在大型项目或者高端配置的服务器有作用，在配置较低的机器上这也没啥用。")]),t._v(" "),a("p",[t._v("不过话说回来，mq肯定不会放在配置低的机器上。")]),t._v(" "),a("h3",{attrs:{id:"_8-注册消息处理器"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_8-注册消息处理器"}},[t._v("#")]),t._v(" 8. 注册消息处理器")]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 注册消息的处理器， 用于处理netty收到的请求")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("registerProcessor")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("rmq 收到消息后，根据rmq的消息协议，一定有一个消息code，他就是根据消息code来获取对应的消息处理器，")]),t._v(" "),a("p",[t._v("从而将请求转发给对应的消息处理器，进行消息的处理。")]),t._v(" "),a("h3",{attrs:{id:"_9-启动定时任务"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_9-启动定时任务"}},[t._v("#")]),t._v(" 9. 启动定时任务")]),t._v(" "),a("ol",[a("li",[t._v("持久化的")]),t._v(" "),a("li",[t._v("状态记录的")]),t._v(" "),a("li",[t._v("更新name server 地址的")])]),t._v(" "),a("h3",{attrs:{id:"_10-初始化事务管理器-initialtransaction"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_10-初始化事务管理器-initialtransaction"}},[t._v("#")]),t._v(" 10. 初始化事务管理器  initialTransaction")]),t._v(" "),a("p",[t._v("rmq的事务消息叫half消息，即发送到rmq后必须在确认一次才算提交成功。")]),t._v(" "),a("h2",{attrs:{id:"_1-3-初始化失败即将brokercontroller-shuntdown"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-3-初始化失败即将brokercontroller-shuntdown"}},[t._v("#")]),t._v(" 1.3 初始化失败即将brokerController ShuntDown")]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[t._v("controller"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("shutdown")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("如果broklerController 初始化失败了，那么需要将控制器启动的响应的资源释放，即调用函数的shutdown() 函数。")]),t._v(" "),a("h1",{attrs:{id:"_2-启动-brokercontroller"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-启动-brokercontroller"}},[t._v("#")]),t._v(" 2. 启动 BrokerController")]),t._v(" "),a("p",[t._v("org.apache.rocketmq.broker.BrokerController#start")]),t._v(" "),a("h2",{attrs:{id:"_2-1-启动messagestore组件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-启动messagestore组件"}},[t._v("#")]),t._v(" 2.1 启动messageStore组件")]),t._v(" "),a("ol",[a("li",[t._v("设置锁文件")]),t._v(" "),a("li",[t._v("更新消费者读取的最大的位置，如果消费者消费的最大位置小于commitLog的最小位置，就以最小的位置开始消费，"),a("strong",[t._v("之前没消费的消息就丢失")])]),t._v(" "),a("li",[t._v("启动reput组件，进行消息转发")]),t._v(" "),a("li",[a("strong",[t._v("启动ha")])]),t._v(" "),a("li",[t._v("."),a("strong",[t._v("FlushConsumeQueueService")]),t._v(" 任务启动")]),t._v(" "),a("li",[t._v("."),a("strong",[t._v("commitLog 服务启动")]),t._v("，可以细看")]),t._v(" "),a("li",[t._v(".StoreStatsService ： 状态监控打印，不太重要，但是作为监控很有用")]),t._v(" "),a("li",[t._v("启动定时任务：\n"),a("ol",[a("li",[t._v("删除过期的commitLog")]),t._v(" "),a("li",[t._v("删除consumerQueue 文件")]),t._v(" "),a("li",[t._v("磁盘空间检查")])])])]),t._v(" "),a("h2",{attrs:{id:"_2-2-启动网络服务组件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-启动网络服务组件"}},[t._v("#")]),t._v(" 2.2 启动网络服务组件")]),t._v(" "),a("p",[t._v("org.apache.rocketmq.broker.BrokerController#start")]),t._v(" "),a("h3",{attrs:{id:"_2-2-1-remotingserver"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-1-remotingserver"}},[t._v("#")]),t._v(" 2.2.1 remotingServer")]),t._v(" "),a("p",[t._v("启动netty服务，org.apache.rocketmq.remoting.netty.NettyRemotingServer#start")]),t._v(" "),a("h3",{attrs:{id:"_2-2-2-文件监控服务-filewatchservice"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-2-文件监控服务-filewatchservice"}},[t._v("#")]),t._v(" 2.2.2 文件监控服务 FileWatchService")]),t._v(" "),a("p",[t._v("org.apache.rocketmq.common.ServiceThread#start")]),t._v(" "),a("p",[t._v("如果被监控的文件的 md5变了，证明文件被修改了。。。")]),t._v(" "),a("h3",{attrs:{id:"_2-2-3-remotingclient-客户端启动-服务端是否需要客户端"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-3-remotingclient-客户端启动-服务端是否需要客户端"}},[t._v("#")]),t._v(" 2.2.3 RemotingClient 客户端启动，服务端是否需要客户端？")]),t._v(" "),a("h3",{attrs:{id:"_2-2-4-pullrequestholdservice"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-4-pullrequestholdservice"}},[t._v("#")]),t._v(" 2.2.4 ：pullRequestHoldService")]),t._v(" "),a("p",[t._v("剩下的感觉不太重要咯。。。。")]),t._v(" "),a("h1",{attrs:{id:"end-各组件介绍"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#end-各组件介绍"}},[t._v("#")]),t._v(" END：各组件介绍")])])}),[],!1,null,null,null);a.default=r.exports}}]);