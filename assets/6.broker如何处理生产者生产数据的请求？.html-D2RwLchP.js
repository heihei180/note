import{_ as i}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as a,d as e,o as n}from"./app-Ck_x_2UU.js";const t={};function h(l,s){return n(),a("div",null,s[0]||(s[0]=[e(`<blockquote><p>思考一个问题，既然弄清楚了服务端是如何接收网络请求，并且他是如果根据请求类型去匹配消息处理器的，那么生产者生产消息的时候，他是如何具体处理这个消息的呢？是使用那个处理器，哪个线程池来处理这个消息的？</p><p>具体的处理流程是什么？</p></blockquote><h1 id="哪个处理器来处理生产消息的请求" tabindex="-1"><a class="header-anchor" href="#哪个处理器来处理生产消息的请求"><span>哪个处理器来处理生产消息的请求</span></a></h1><h2 id="_1-确定消息类型" tabindex="-1"><a class="header-anchor" href="#_1-确定消息类型"><span>1. 确定消息类型</span></a></h2><p>根据生产者发送的消息类型来确定生产者客户端发送的消息的类型是什么？</p><p>所以需要追踪源码来确认。</p><p>堆栈</p><div class="language-text line-numbers-mode" data-highlighter="shiki" data-ext="text" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-text"><span class="line"><span>org.apache.rocketmq.client.producer.DefaultMQProducer#send(org.apache.rocketmq.common.message.Message)</span></span>
<span class="line"><span>	org.apache.rocketmq.client.impl.producer.DefaultMQProducerImpl#send(org.apache.rocketmq.common.message.Message)</span></span>
<span class="line"><span>		org.apache.rocketmq.client.impl.producer.DefaultMQProducerImpl#send(org.apache.rocketmq.common.message.Message, long)</span></span>
<span class="line"><span>			org.apache.rocketmq.client.impl.producer.DefaultMQProducerImpl#sendDefaultImpl</span></span>
<span class="line"><span>				org.apache.rocketmq.client.impl.producer.DefaultMQProducerImpl#sendKernelImpl</span></span>
<span class="line"><span>					org.apache.rocketmq.client.impl.MQClientAPIImpl#sendMessage</span></span>
<span class="line"><span>						org.apache.rocketmq.client.impl.MQClientAPIImpl#sendMessage</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-java"><span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">                request </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> RemotingCommand</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">createRequestCommand</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(msg </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">instanceof</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> MessageBatch </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">?</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> RequestCode</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">SEND_BATCH_MESSAGE</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> :</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> RequestCode</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">SEND_MESSAGE_V2</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, requestHeaderV2);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>可见，如果是批量消息 <code>MessageBatch</code> ，消息类型是：<code>RequestCode.SEND_BATCH_MESSAGE</code></p><p>否则就是：<code>RequestCode.SEND_MESSAGE_V2</code> code=310</p><h2 id="_2-确认处理消息的处理器是哪个" tabindex="-1"><a class="header-anchor" href="#_2-确认处理消息的处理器是哪个"><span>2. 确认处理消息的处理器是哪个？</span></a></h2><p>broker 获取处理器的位置：</p><p><strong>org.apache.rocketmq.remoting.netty.NettyRemotingAbstract#processRequestCommand</strong></p><p>在broker获取处理器的位置打上条件断点，可以看到：</p><figure><img src="https://gitee.com/gq2/img_repo2/raw/master/img/image-20240317141949087.png" alt="image-20240317141949087" tabindex="0" loading="lazy"><figcaption>image-20240317141949087</figcaption></figure><figure><img src="https://gitee.com/gq2/img_repo2/raw/master/img/image-20240317141720507.png" alt="xxx" tabindex="0" loading="lazy"><figcaption>xxx</figcaption></figure><p>code 310 对应的处理器是 <strong>SendMessageProcessor</strong></p><h2 id="_3-sendmessageprocessor-如何处理请求的" tabindex="-1"><a class="header-anchor" href="#_3-sendmessageprocessor-如何处理请求的"><span>3. SendMessageProcessor 如何处理请求的？</span></a></h2><p>SendMessageProcessor的类图</p><figure><img src="https://gitee.com/gq2/img_repo2/raw/master/img/image-20240317142301835.png" alt="image-20240317142301835" tabindex="0" loading="lazy"><figcaption>image-20240317142301835</figcaption></figure><p>broker选择处理器是异步还是同步处理：</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">                        if</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> (</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">pair</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getObject1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> instanceof</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> AsyncNettyRequestProcessor) {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">                            AsyncNettyRequestProcessor</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> processor </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> (AsyncNettyRequestProcessor)</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">pair</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getObject1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">                            processor</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">asyncProcessRequest</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(ctx, cmd, callback);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">                        } </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">else</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">                            NettyRequestProcessor</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> processor </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> pair</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getObject1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">                            RemotingCommand</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> response </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> processor</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">processRequest</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(ctx, cmd);</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">                            callback</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">callback</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(response);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">                        }</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>根据上面类继承图可以看到，<strong>SendMessageProcessor</strong> 继承了 <strong>AsyncNettyRequestProcessor</strong> ，因此他是异步处理的。</p><h2 id="_4-sendmessageprocessor异步处理" tabindex="-1"><a class="header-anchor" href="#_4-sendmessageprocessor异步处理"><span>4. SendMessageProcessor异步处理</span></a></h2><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> asyncProcessRequest</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">ChannelHandlerContext</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> ctx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> RemotingCommand</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> request</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> RemotingResponseCallback</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> responseCallback) throws Exception {</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">        asyncProcessRequest</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(ctx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> request)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">thenAcceptAsync</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(responseCallback</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">::</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">callback, </span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">this</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">brokerController</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getSendMessageExecutor</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">());</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    }</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>上面代码是SendMessageProcessor的处理函数，可以看出他进行了异步任务的编排</p><ul><li>先进行<code>asyncProcessRequest</code> 处理业务逻辑</li><li>然后<code>thenAcceptAsync(responseCallback::callback, this.brokerController.getSendMessageExecutor()) </code>在线程池中执行回调函数</li></ul><h3 id="_4-1-处理逻辑" tabindex="-1"><a class="header-anchor" href="#_4-1-处理逻辑"><span>4.1 处理逻辑</span></a></h3><blockquote><p>比较复杂</p></blockquote><h4 id="_4-1-1-解析请求头" tabindex="-1"><a class="header-anchor" href="#_4-1-1-解析请求头"><span>4.1.1 解析请求头</span></a></h4><p>org.apache.rocketmq.broker.processor.AbstractSendMessageProcessor#parseRequestHeader</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">SendMessageRequestHeader</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> requestHeader </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> parseRequestHeader</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(request)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h4 id="_4-1-2-前置拦截" tabindex="-1"><a class="header-anchor" href="#_4-1-2-前置拦截"><span>4.1.2 前置拦截</span></a></h4><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">this</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">executeSendMessageHookBefore</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(ctx, request, mqtraceContext);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h4 id="_4-1-3-执行实际逻辑" tabindex="-1"><a class="header-anchor" href="#_4-1-3-执行实际逻辑"><span>4.1.3 执行实际逻辑</span></a></h4><p>批量消息：</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">return</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> this</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">asyncSendBatchMessage</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(ctx, request, mqtraceContext, requestHeader);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>非批量消息：</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">return</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> this</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">asyncSendMessage</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(ctx, request, mqtraceContext, requestHeader);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h2 id="_5-非批量消息的处理" tabindex="-1"><a class="header-anchor" href="#_5-非批量消息的处理"><span>5. 非批量消息的处理</span></a></h2><p>org.apache.rocketmq.broker.processor.SendMessageProcessor#asyncSendMessage</p><h3 id="_5-1-将消息转换成内部消息格式-messageextbrokerinner" tabindex="-1"><a class="header-anchor" href="#_5-1-将消息转换成内部消息格式-messageextbrokerinner"><span>5.1 将消息转换成内部消息格式：MessageExtBrokerInner</span></a></h3><blockquote><p>转换过程没必要写了吧</p></blockquote><h3 id="_5-2-是否死信或者延迟消息" tabindex="-1"><a class="header-anchor" href="#_5-2-是否死信或者延迟消息"><span>5.2 是否死信或者延迟消息？</span></a></h3><p>是的话就直接处理，然后结束，不是的话就继续往下执行。。。</p><p>TODO: 等待以后在看这个</p><h3 id="_5-3-是否事务消息-以及事务消息的处理" tabindex="-1"><a class="header-anchor" href="#_5-3-是否事务消息-以及事务消息的处理"><span>5.3 是否事务消息？以及事务消息的处理</span></a></h3><p>事务消息的处理见：this.brokerController.getTransactionalMessageService().asyncPrepareMessage(msgInner);</p><h3 id="_5-4-普通消息的处理" tabindex="-1"><a class="header-anchor" href="#_5-4-普通消息的处理"><span>5.4 普通消息的处理</span></a></h3><p>见代码：this.brokerController.getMessageStore().asyncPutMessage(msgInner)</p><p>因为我们的消息是普通消息，因此肯定走的是普通消息流程</p><p>即通过DefaultMessageStore将消息存储到commitLog中，下面再说如何存储消息</p><h2 id="_6-消息存储" tabindex="-1"><a class="header-anchor" href="#_6-消息存储"><span>6. 消息存储</span></a></h2><p>org.apache.rocketmq.store.DefaultMessageStore#asyncPutMessage</p><p>defaultMessageStore也是委托commitLog对象处理消息的追加</p><p>即：this.commitLog.asyncPutMessage(msg);</p><h3 id="_6-1-commitlog-对消息的存储" tabindex="-1"><a class="header-anchor" href="#_6-1-commitlog-对消息的存储"><span>6.1 commitLog 对消息的存储</span></a></h3><p>org.apache.rocketmq.store.CommitLog#asyncPutMessage</p><h4 id="_6-1-1-写文件" tabindex="-1"><a class="header-anchor" href="#_6-1-1-写文件"><span>6.1.1 写文件</span></a></h4><ol><li>先加写锁</li><li>获取最新的mapFile</li><li>如果mapedFile是空的就创建一个新的文件，如果mapedFile满了就在创建一个文件</li><li>将消息追加到mapedFile上</li></ol><h4 id="_6-1-2-mapedfile-消息追加" tabindex="-1"><a class="header-anchor" href="#_6-1-2-mapedfile-消息追加"><span>6.1.2 mapedFile 消息追加</span></a></h4><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">org</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">apache</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">rocketmq</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">store</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">MappedFile</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">#</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">appendMessage</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">org</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">apache</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">rocketmq</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">store</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">MessageExtBrokerInner</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> org</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">apache</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">rocketmq</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">store</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">AppendMessageCallback</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> org</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">apache</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">rocketmq</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">store</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">CommitLog</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">PutMessageContext</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><div class="language-text line-numbers-mode" data-highlighter="shiki" data-ext="text" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-text"><span class="line"><span>org.apache.rocketmq.store.MappedFile#appendMessagesInner</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> AppendMessageResult</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> appendMessagesInner</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">final</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> MessageExt</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> messageExt</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> final</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> AppendMessageCallback</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> cb</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">                                                   PutMessageContext</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> putMessageContext) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">            // 获取 mappedFile的buffer对象、</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">            ByteBuffer</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> byteBuffer </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> writeBuffer </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">!=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> null</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> ?</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> writeBuffer</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">slice</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> :</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> this</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">mappedByteBuffer</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">slice</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">            // 位置标记</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">            byteBuffer</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">position</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(currentPos);</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">                // 普通消息</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">             AppendMessageResult</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">   result </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> cb</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">doAppend</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">this</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getFileFromOffset</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(), byteBuffer, </span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">this</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">fileSize</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> -</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> currentPos,</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">                        (MessageExtBrokerInner) messageExt, putMessageContext);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            return</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> result</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    }</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可见，<strong>mappedFile的追加函数 实际追加逻辑委托给了 cb 对象</strong>，通过代码回溯，知道cb 是：<code>DefaultAppendMessageCallback</code></p><p>因此，需要想要知道消息是如何写入到了mappedFile中，需要看 <code>CommitLog.DefaultAppendMessageCallback#doAppend()</code></p><p>将消息写入了 MappedByteBuffer 中，等待 page cache 刷新 或者 force 才会将数据写入到磁盘中。</p>`,67)]))}const r=i(t,[["render",h]]),d=JSON.parse('{"path":"/Java/RocketMQ/6.broker%E5%A6%82%E4%BD%95%E5%A4%84%E7%90%86%E7%94%9F%E4%BA%A7%E8%80%85%E7%94%9F%E4%BA%A7%E6%95%B0%E6%8D%AE%E7%9A%84%E8%AF%B7%E6%B1%82%EF%BC%9F.html","title":"哪个处理器来处理生产消息的请求","lang":"zh-CN","frontmatter":{"description":"思考一个问题，既然弄清楚了服务端是如何接收网络请求，并且他是如果根据请求类型去匹配消息处理器的，那么生产者生产消息的时候，他是如何具体处理这个消息的呢？是使用那个处理器，哪个线程池来处理这个消息的？ 具体的处理流程是什么？ 哪个处理器来处理生产消息的请求 1. 确定消息类型 根据生产者发送的消息类型来确定生产者客户端发送的消息的类型是什么？ 所以需要追...","head":[["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"哪个处理器来处理生产消息的请求\\",\\"image\\":[\\"https://gitee.com/gq2/img_repo2/raw/master/img/image-20240317141949087.png\\",\\"https://gitee.com/gq2/img_repo2/raw/master/img/image-20240317141720507.png\\",\\"https://gitee.com/gq2/img_repo2/raw/master/img/image-20240317142301835.png\\"],\\"dateModified\\":\\"2025-08-04T07:01:30.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"heihei180\\",\\"url\\":\\"https://github.com/heihei180\\"}]}"],["meta",{"property":"og:url","content":"https://vuepress-theme-hope-docs-demo.netlify.app/note/Java/RocketMQ/6.broker%E5%A6%82%E4%BD%95%E5%A4%84%E7%90%86%E7%94%9F%E4%BA%A7%E8%80%85%E7%94%9F%E4%BA%A7%E6%95%B0%E6%8D%AE%E7%9A%84%E8%AF%B7%E6%B1%82%EF%BC%9F.html"}],["meta",{"property":"og:site_name","content":"筆記本首頁"}],["meta",{"property":"og:title","content":"哪个处理器来处理生产消息的请求"}],["meta",{"property":"og:description","content":"思考一个问题，既然弄清楚了服务端是如何接收网络请求，并且他是如果根据请求类型去匹配消息处理器的，那么生产者生产消息的时候，他是如何具体处理这个消息的呢？是使用那个处理器，哪个线程池来处理这个消息的？ 具体的处理流程是什么？ 哪个处理器来处理生产消息的请求 1. 确定消息类型 根据生产者发送的消息类型来确定生产者客户端发送的消息的类型是什么？ 所以需要追..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:image","content":"https://gitee.com/gq2/img_repo2/raw/master/img/image-20240317141949087.png"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2025-08-04T07:01:30.000Z"}],["meta",{"property":"article:modified_time","content":"2025-08-04T07:01:30.000Z"}]]},"git":{"createdTime":1754290890000,"updatedTime":1754290890000,"contributors":[{"name":"wanggq10","username":"wanggq10","email":"wanggq10@lenovo.com","commits":1,"url":"https://github.com/wanggq10"}]},"readingTime":{"minutes":3.04,"words":911},"filePathRelative":"Java/RocketMQ/6.broker如何处理生产者生产数据的请求？.md","autoDesc":true}');export{r as comp,d as data};
