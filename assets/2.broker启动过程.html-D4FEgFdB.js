import{_ as r}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as h,a as s,d as t,b as a,f as l,w as n,r as k,o as p}from"./app-BXbGu2dC.js";const o={};function d(g,i){const e=k("RouteLink");return p(),h("div",null,[i[21]||(i[21]=s("h1",{id:"_1-启动入口",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#_1-启动入口"},[s("span",null,"1. 启动入口")])],-1)),i[22]||(i[22]=s("p",null,"org.apache.rocketmq.broker.BrokerStartup#main",-1)),i[23]||(i[23]=s("p",null,"执行main函数之后，创建控制器",-1)),i[24]||(i[24]=s("p",null,"org.apache.rocketmq.broker.BrokerStartup#createBrokerController",-1)),i[25]||(i[25]=s("h2",{id:"_1-1-brokercontroller介绍",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#_1-1-brokercontroller介绍"},[s("span",null,"1.1 brokerController介绍")])],-1)),i[26]||(i[26]=s("p",null,"broker控制器，就是broker核心管理组件，",-1)),i[27]||(i[27]=s("p",null,"包含了几个核心配置：",-1)),s("ul",null,[i[10]||(i[10]=s("li",null,[s("p",null,"BrokerConfig: broker基础配置")],-1)),i[11]||(i[11]=s("li",null,[s("p",null,"NettyServerConfig：nettyserver的配置")],-1)),i[12]||(i[12]=s("li",null,[s("p",null,"NettyClientConfig")],-1)),s("li",null,[s("p",null,[i[1]||(i[1]=a("MessageStoreConfig： ",-1)),l(e,{to:"/Java/RocketMQ/brokerController%E7%BB%84%E4%BB%B6%E4%BB%8B%E7%BB%8D/MessageStoreConfig.html"},{default:n(()=>i[0]||(i[0]=[a("消息存储配置",-1)])),_:1,__:[0]})])]),s("li",null,[s("p",null,[i[3]||(i[3]=a("RebalanceLockManager： ",-1)),l(e,{to:"/Java/RocketMQ/brokerController%E7%BB%84%E4%BB%B6%E4%BB%8B%E7%BB%8D/RebalanceLockManager.html"},{default:n(()=>i[2]||(i[2]=[a("消费者客户端重平衡时候的绑定关系管理",-1)])),_:1,__:[2]})])]),s("li",null,[s("p",null,[i[5]||(i[5]=a("ConsumerOffsetManager： ",-1)),l(e,{to:"/Java/RocketMQ/brokerController%E7%BB%84%E4%BB%B6%E4%BB%8B%E7%BB%8D/ConsumerOffsetManager.html"},{default:n(()=>i[4]||(i[4]=[a("消费偏移管理器",-1)])),_:1,__:[4]})])]),s("li",null,[s("p",null,[i[7]||(i[7]=a("TopicConfigManager： ",-1)),l(e,{to:"/Java/RocketMQ/brokerController%E7%BB%84%E4%BB%B6%E4%BB%8B%E7%BB%8D/TopicConfigManager.html"},{default:n(()=>i[6]||(i[6]=[a("topic管理器 ",-1)])),_:1,__:[6]})])]),i[13]||(i[13]=s("li",null,[s("p",null,"PullMessageProcessor：消息拉取处理器")],-1)),i[14]||(i[14]=s("li",null,[s("p",null,"PullRequestHoldService")],-1)),i[15]||(i[15]=s("li",null,[s("p",null,"NotifyMessageArrivingListener：消息到达通知器")],-1)),i[16]||(i[16]=s("li",null,[s("p",null,"DefaultConsumerIdsChangeListener：没看懂干啥的、")],-1)),i[17]||(i[17]=s("li",null,[s("p",null,"ConsumerManager：消费者管理器===具体作用不知道，")],-1)),i[18]||(i[18]=s("li",null,[s("p",null,"ConsumerFilterManager：这个肯定是管理消费者的过滤器的")],-1)),s("li",null,[s("p",null,[i[9]||(i[9]=a("ProducerManager：生产者管理 ,详细介绍： ",-1)),l(e,{to:"/Java/RocketMQ/brokerController%E7%BB%84%E4%BB%B6%E4%BB%8B%E7%BB%8D/ProducerManager%E4%BB%8B%E7%BB%8D.html"},{default:n(()=>i[8]||(i[8]=[a("ProducerManager介绍",-1)])),_:1,__:[8]})])]),i[19]||(i[19]=t("<li><p>ClientHousekeepingService：管理客户端是否掉线吧。</p></li><li><p>Broker2Client</p></li><li><p>SubscriptionGroupManager：订阅组</p></li><li><p>BrokerOuterAPI：broker外部api</p></li><li><p>FilterServerManager：</p></li><li><p>SlaveSynchronize：salve同步</p></li><li><p>BrokerStatsManager：broker状态管理</p></li><li><p>BrokerFastFailure：</p></li><li><p>Configuration：</p></li>",9))]),i[28]||(i[28]=t(`<h2 id="_1-2-创建和初始化brokercontroller" tabindex="-1"><a class="header-anchor" href="#_1-2-创建和初始化brokercontroller"><span>1.2 创建和初始化brokerController</span></a></h2><h3 id="_1-加载本地配置文件" tabindex="-1"><a class="header-anchor" href="#_1-加载本地配置文件"><span>1. 加载本地配置文件</span></a></h3><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// topic配置</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">boolean</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> result </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> this</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">topicConfigManager</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">load</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// 消费偏移</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">result </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> result </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&amp;&amp;</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> this</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">consumerOffsetManager</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">load</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// 订阅关系</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">result </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> result </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&amp;&amp;</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> this</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">subscriptionGroupManager</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">load</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// 消费者的filter</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">result </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> result </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&amp;&amp;</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> this</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">consumerFilterManager</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">load</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-defaultmessagestore消息存储对象初始化" tabindex="-1"><a class="header-anchor" href="#_2-defaultmessagestore消息存储对象初始化"><span>2.DefaultMessageStore消息存储对象初始化</span></a></h3><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">/// 创建默认的存储对象</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// 使用几个 commitLog， index reput 之类的 类协调底层的存储逻辑、</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">this</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">messageStore</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    new</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> DefaultMessageStore</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">this</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">messageStoreConfig</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> this</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">brokerStatsManager</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> this</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">messageArrivingListener</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> this</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">brokerConfig</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><em><strong>DefaultMessageStore</strong></em>：</p><blockquote><p>默认的消息存储管理组件</p><p>rocketMq的存储核心组件，可以说是最重要的组件，没有之一，rmq 主要功能就是网络，存储。</p></blockquote>`,7)),s("p",null,[l(e,{to:"/Java/RocketMQ/brokerController%E7%BB%84%E4%BB%B6%E4%BB%8B%E7%BB%8D/DefaultMessageStore.html"},{default:n(()=>i[20]||(i[20]=[a("消息存储管理组件DefaultMessageStore",-1)])),_:1,__:[20]})]),i[29]||(i[29]=t(`<h3 id="_3-dledgerrolechangehandler-支持" tabindex="-1"><a class="header-anchor" href="#_3-dledgerrolechangehandler-支持"><span>3. DLedgerRoleChangeHandler 支持</span></a></h3><blockquote><p>这个新特性我没有接触过，可以了解一下。</p></blockquote><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">if</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> (</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">messageStoreConfig</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">isEnableDLegerCommitLog</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">) {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">    DLedgerRoleChangeHandler</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> roleChangeHandler </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> DLedgerRoleChangeHandler</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">this</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> (DefaultMessageStore) messageStore)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    ((DLedgerCommitLog)((DefaultMessageStore) messageStore)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getCommitLog</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getdLedgerServer</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getdLedgerLeaderElector</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">addRoleChangeHandler</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(roleChangeHandler);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-拦截器的添加" tabindex="-1"><a class="header-anchor" href="#_4-拦截器的添加"><span>4. 拦截器的添加</span></a></h3><blockquote><p>rmq接收到消息之后，要进行一系列的构建索引，分发到不同的messageQueue之类的操作，就是通过 reput 线程做的，他好像就是一个拦截器，rmq收到消息后会执行 这里添加的拦截器，可以关注下，有助于了解rmq的消息转发流程，但是不是太难也不是高级的技术。因此知道即可。</p></blockquote><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// 添加消息分发的过滤器。 这个默认的 是 支持 标签过滤的， 即rocket消费者 可以在订阅的时候传递表达式，</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// 这里就是计算消息和那个表达式的match关系的，match的发给消费者，不match的不发给消费者</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// todo: 每条消息都要经过所有的这些分发器，可以用它来分发消息，同样，也可以用它来过滤消息，或者构建索引</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">this</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">messageStore</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getDispatcherList</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">addFirst</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">new</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> CommitLogDispatcherCalcBitMap</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">this</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">brokerConfig</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">this</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">consumerFilterManager</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">));</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>其实为了佐证我上面的猜想，可以去messageStore的类中去看是不是添加了默认的消息拦截器</p><p>org.apache.rocketmq.store.DefaultMessageStore#DefaultMessageStore</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">this</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">dispatcherList</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> new</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> LinkedList</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">()</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">this</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">dispatcherList</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">addLast</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">new</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> CommitLogDispatcherBuildConsumeQueue</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">());</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">this</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">dispatcherList</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">addLast</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">new</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> CommitLogDispatcherBuildIndex</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">());</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到，添加了两个默认的消息拦截器，构建consumerQueue和索引，messageQueue不是，可以后续看下messageQueue中的消息是如何构建的，我现在忘了，记不清了。</p><h3 id="_5-messagestore-加载commitlog-文件" tabindex="-1"><a class="header-anchor" href="#_5-messagestore-加载commitlog-文件"><span>5. messageStore 加载commitLog 文件</span></a></h3><p>这一步会加载commitLog，index 之类的本地文件，将磁盘文件和本地内存建立内存映射关系</p><p>org.apache.rocketmq.store.DefaultMessageStore#load</p><p>即，作用是保证本地磁盘文件的完整性。</p><h3 id="_6-网络相关组件的初始化" tabindex="-1"><a class="header-anchor" href="#_6-网络相关组件的初始化"><span>6. 网络相关组件的初始化</span></a></h3><ol><li>.<strong>remotingServer</strong> ：提供web服务的服务器</li><li>.fastRemotingServer：和上面一样，但是不知道是什么意思</li></ol><h3 id="_7-启动相关的线程池" tabindex="-1"><a class="header-anchor" href="#_7-启动相关的线程池"><span>7. 启动相关的线程池</span></a></h3><p>建立了很多的线程池，不知道有啥用？这就是线程隔离？在大型项目或者高端配置的服务器有作用，在配置较低的机器上这也没啥用。</p><p>不过话说回来，mq肯定不会放在配置低的机器上。</p><h3 id="_8-注册消息处理器" tabindex="-1"><a class="header-anchor" href="#_8-注册消息处理器"><span>8. 注册消息处理器</span></a></h3><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// 注册消息的处理器， 用于处理netty收到的请求</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">this</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">registerProcessor</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>rmq 收到消息后，根据rmq的消息协议，一定有一个消息code，他就是根据消息code来获取对应的消息处理器，</p><p>从而将请求转发给对应的消息处理器，进行消息的处理。</p><h3 id="_9-启动定时任务" tabindex="-1"><a class="header-anchor" href="#_9-启动定时任务"><span>9. 启动定时任务</span></a></h3><ol><li>持久化的</li><li>状态记录的</li><li>更新name server 地址的</li></ol><h3 id="_10-初始化事务管理器-initialtransaction" tabindex="-1"><a class="header-anchor" href="#_10-初始化事务管理器-initialtransaction"><span>10. 初始化事务管理器 initialTransaction</span></a></h3><p>rmq的事务消息叫half消息，即发送到rmq后必须在确认一次才算提交成功。</p><h2 id="_1-3-初始化失败即将brokercontroller-shuntdown" tabindex="-1"><a class="header-anchor" href="#_1-3-初始化失败即将brokercontroller-shuntdown"><span>1.3 初始化失败即将brokerController ShuntDown</span></a></h2><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">controller</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">shutdown</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>如果broklerController 初始化失败了，那么需要将控制器启动的响应的资源释放，即调用函数的shutdown() 函数。</p><h1 id="_2-启动-brokercontroller" tabindex="-1"><a class="header-anchor" href="#_2-启动-brokercontroller"><span>2. 启动 BrokerController</span></a></h1><p>org.apache.rocketmq.broker.BrokerController#start</p><h2 id="_2-1-启动messagestore组件" tabindex="-1"><a class="header-anchor" href="#_2-1-启动messagestore组件"><span>2.1 启动messageStore组件</span></a></h2><ol><li>设置锁文件</li><li>更新消费者读取的最大的位置，如果消费者消费的最大位置小于commitLog的最小位置，就以最小的位置开始消费，<strong>之前没消费的消息就丢失</strong></li><li>启动reput组件，进行消息转发</li><li><strong>启动ha</strong></li><li>.<strong>FlushConsumeQueueService</strong> 任务启动</li><li>.<strong>commitLog 服务启动</strong>，可以细看</li><li>.StoreStatsService ： 状态监控打印，不太重要，但是作为监控很有用</li><li>启动定时任务： <ol><li>删除过期的commitLog</li><li>删除consumerQueue 文件</li><li>磁盘空间检查</li></ol></li></ol><h2 id="_2-2-启动网络服务组件" tabindex="-1"><a class="header-anchor" href="#_2-2-启动网络服务组件"><span>2.2 启动网络服务组件</span></a></h2><p>org.apache.rocketmq.broker.BrokerController#start</p><h3 id="_2-2-1-remotingserver" tabindex="-1"><a class="header-anchor" href="#_2-2-1-remotingserver"><span>2.2.1 remotingServer</span></a></h3><p>启动netty服务，org.apache.rocketmq.remoting.netty.NettyRemotingServer#start</p><h3 id="_2-2-2-文件监控服务-filewatchservice" tabindex="-1"><a class="header-anchor" href="#_2-2-2-文件监控服务-filewatchservice"><span>2.2.2 文件监控服务 FileWatchService</span></a></h3><p>org.apache.rocketmq.common.ServiceThread#start</p><p>如果被监控的文件的 md5变了，证明文件被修改了。。。</p><h3 id="_2-2-3-remotingclient-客户端启动-服务端是否需要客户端" tabindex="-1"><a class="header-anchor" href="#_2-2-3-remotingclient-客户端启动-服务端是否需要客户端"><span>2.2.3 RemotingClient 客户端启动，服务端是否需要客户端？</span></a></h3><h3 id="_2-2-4-pullrequestholdservice" tabindex="-1"><a class="header-anchor" href="#_2-2-4-pullrequestholdservice"><span>2.2.4 ：pullRequestHoldService</span></a></h3><p>剩下的感觉不太重要咯。。。。</p><h1 id="end-各组件介绍" tabindex="-1"><a class="header-anchor" href="#end-各组件介绍"><span>END：各组件介绍</span></a></h1>`,45))])}const u=r(o,[["render",d]]),c=JSON.parse('{"path":"/Java/RocketMQ/2.broker%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B.html","title":"1. 启动入口","lang":"zh-CN","frontmatter":{"description":"1. 启动入口 org.apache.rocketmq.broker.BrokerStartup#main 执行main函数之后，创建控制器 org.apache.rocketmq.broker.BrokerStartup#createBrokerController 1.1 brokerController介绍 broker控制器，就是broker核...","head":[["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"1. 启动入口\\",\\"image\\":[\\"\\"],\\"dateModified\\":\\"2025-08-04T07:01:30.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"heihei180\\",\\"url\\":\\"https://github.com/heihei180\\"}]}"],["meta",{"property":"og:url","content":"https://vuepress-theme-hope-docs-demo.netlify.app/note/Java/RocketMQ/2.broker%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B.html"}],["meta",{"property":"og:site_name","content":"筆記本首頁"}],["meta",{"property":"og:title","content":"1. 启动入口"}],["meta",{"property":"og:description","content":"1. 启动入口 org.apache.rocketmq.broker.BrokerStartup#main 执行main函数之后，创建控制器 org.apache.rocketmq.broker.BrokerStartup#createBrokerController 1.1 brokerController介绍 broker控制器，就是broker核..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2025-08-04T07:01:30.000Z"}],["meta",{"property":"article:modified_time","content":"2025-08-04T07:01:30.000Z"}]]},"git":{"createdTime":1754290890000,"updatedTime":1754290890000,"contributors":[{"name":"wanggq10","username":"wanggq10","email":"wanggq10@lenovo.com","commits":1,"url":"https://github.com/wanggq10"}]},"readingTime":{"minutes":4.66,"words":1399},"filePathRelative":"Java/RocketMQ/2.broker启动过程.md","autoDesc":true}');export{u as comp,c as data};
