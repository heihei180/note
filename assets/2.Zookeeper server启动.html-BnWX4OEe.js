import{_ as s}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as a,d as n,o as e}from"./app-qQ-ljpVm.js";const l={};function t(h,i){return e(),a("div",null,i[0]||(i[0]=[n(`<p>zk 客户端工具：<a href="https://github.com/vran-dev/PrettyZoo/releases" target="_blank" rel="noopener noreferrer">https://github.com/vran-dev/PrettyZoo/releases</a> （已停止维护）</p><h2 id="_1-拉起代码" tabindex="-1"><a class="header-anchor" href="#_1-拉起代码"><span>1. 拉起代码</span></a></h2><p>GitHub</p><h2 id="_2-导入idea" tabindex="-1"><a class="header-anchor" href="#_2-导入idea"><span>2. 导入idea</span></a></h2><h3 id="_2-1-编译" tabindex="-1"><a class="header-anchor" href="#_2-1-编译"><span>2.1 编译</span></a></h3><p>导入idea之后，先不要进行启动代码，先进行编译一次：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">mvn</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> clean</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> package</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -DskipTests</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="_2-2更新pom" tabindex="-1"><a class="header-anchor" href="#_2-2更新pom"><span>2.2更新pom</span></a></h3><p>更新 server 模块下的pom，因有些依赖的scope是provide，将其注释掉，直接导入</p><ul><li>jetty 相关</li><li>snappy-java</li><li>metrics-core</li></ul><h3 id="_2-3-配置文件" tabindex="-1"><a class="header-anchor" href="#_2-3-配置文件"><span>2.3 配置文件</span></a></h3><p>打开conf目录，将zoo_sample.cfg 复制一份，更新其中的dataDir，然后复制绝对路径。</p><h2 id="_3-运行zk" tabindex="-1"><a class="header-anchor" href="#_3-运行zk"><span>3 运行Zk</span></a></h2><p>根据启动脚本，知道zK的主启动类是：</p><p><code>org.apache.zookeeper.server.quorum.QuorumPeerMain#main</code></p><p>运行前，将 配置文件路径拷贝到程序启动参数中。</p><h1 id="流程解析" tabindex="-1"><a class="header-anchor" href="#流程解析"><span>流程解析</span></a></h1><p>org.apache.zookeeper.server.quorum.QuorumPeerMain#main</p><p>org.apache.zookeeper.server.quorum.QuorumPeerMain#initializeAndRun</p><ul><li>初始化配置 QuorumPeerConfig <ul><li>初始化默认配置</li><li>读取刚刚传入的配置文件中的配置，已配置文件中的配置覆盖默认配置，如果有。</li></ul></li><li>创建和启动：DatadirCleanupManager 数据文件清理器 <ul><li>用于清理快照和事务日志</li><li>清理任务实现：org.apache.zookeeper.server.DatadirCleanupManager.PurgeTask#PurgeTask</li><li><strong>这里只创建了没有启动</strong></li></ul></li><li><strong>判断是分布式还是单机？这里是单机模式</strong></li><li>启动单机模式：org.apache.zookeeper.server.ZooKeeperServerMain#main</li><li>启动单机模式：org.apache.zookeeper.server.ZooKeeperServerMain#initializeAndRun</li><li>初始化配置对象：ServerConfig</li><li>启动单机模式：org.apache.zookeeper.server.ZooKeeperServerMain#runFromConfig</li></ul><h1 id="_4-启动单机模式" tabindex="-1"><a class="header-anchor" href="#_4-启动单机模式"><span>4.启动单机模式</span></a></h1><p>代码入口位置：org.apache.zookeeper.server.ZooKeeperServerMain#runFromConfig</p><h2 id="_4-1指标相关" tabindex="-1"><a class="header-anchor" href="#_4-1指标相关"><span>4.1指标相关</span></a></h2><p>忽略不看，主要就是采集zk的信息，方便后期发送给promthes之类</p><h2 id="_4-2-权限认证" tabindex="-1"><a class="header-anchor" href="#_4-2-权限认证"><span>4.2 权限认证</span></a></h2><p>加载Zk的权限认证组件</p><p>ProviderRegistry.initialize();</p><h2 id="_4-3-filetxnsnaplog-工具类" tabindex="-1"><a class="header-anchor" href="#_4-3-filetxnsnaplog-工具类"><span>4.3 FileTxnSnapLog 工具类</span></a></h2><p>FileTxnSnapLog 是一个工具类用于协助管理 操作 <code>dataDir</code> , <code>snapDir</code> 两个类</p><p>分别存放：</p><p>// 事务日志文件</p><ul><li>txnLog = new FileTxnLog(this.dataDir);</li></ul><p>// 快照文件</p><ul><li>snapLog = new FileSnap(this.snapDir);</li></ul><h2 id="_4-4-创建zk实例" tabindex="-1"><a class="header-anchor" href="#_4-4-创建zk实例"><span>4.4 创建zk实例</span></a></h2><p>org.apache.zookeeper.server.ZooKeeperServer#ZooKeeperServer(org.apache.zookeeper.server.util.JvmPauseMonitor, org.apache.zookeeper.server.persistence.FileTxnSnapLog, int, int, int, int, org.apache.zookeeper.server.ZKDatabase, java.lang.String)</p><blockquote><p>ZooKeeperServer 430 行</p></blockquote><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    /**</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">     *  * Creates a ZooKeeperServer instance. It sets everything up, but doesn&#39;t</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">     * actually start listening for clients until run() is invoked.</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">     *</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">     */</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    public</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> ZooKeeperServer</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">FileTxnSnapLog</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> txnLogFactory</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> int</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> tickTime</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> int</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> minSessionTimeout</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> int</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> maxSessionTimeout</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> int</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> clientPortListenBacklog</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> ZKDatabase</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> zkDb</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> String</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> initialConfig</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> boolean</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> reconfigEnabled) {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        // 用于记录服务器运行时的各种统计信息（如处理请求数量、延迟等）。</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">        serverStats </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> ServerStats</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">this</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        // 管理事务日志和快照的工厂类。</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        this</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">txnLogFactory</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> txnLogFactory</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        this</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">txnLogFactory</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">setServerStats</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">this</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">serverStats</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        // 存储 ZooKeeper 数据树和事务日志的数据库对象</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        this</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">zkDb</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> zkDb</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        //  ZooKeeper 的基本时间单位（以毫秒为单位），用于控制心跳、超时等。</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        this</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">tickTime</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> tickTime</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        // 客户端会话最小超时时间。</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">        setMinSessionTimeout</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(minSessionTimeout)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        //  客户端会话最大超时时间。</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">        setMaxSessionTimeout</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(maxSessionTimeout)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        // 客户端连接请求的最大排队数。 TCP/IP 协议中的 listen backlog 参数。</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        this</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">listenBacklog</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> clientPortListenBacklog</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        //是否启用动态重新配置。</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        this</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">reconfigEnabled</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> reconfigEnabled</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        // 用于监听服务器状态变化（比如启动、停止等事件）</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">        listener </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> ZooKeeperServerListenerImpl</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">this</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        // 初始化读取响应缓存（用于 getData 请求），大小从系统属性或默认值获取。</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">        readResponseCache </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> ResponseCache</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">Integer</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getInteger</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            GET_DATA_RESPONSE_CACHE_SIZE,</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">            ResponseCache</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">DEFAULT_RESPONSE_CACHE_SIZE</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">),</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;getData&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        // 初始化获取子节点响应缓存（用于 getChildren 请求），大小从系统属性或默认值获取。</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">        getChildrenResponseCache </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> ResponseCache</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">Integer</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getInteger</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            GET_CHILDREN_RESPONSE_CACHE_SIZE,</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">            ResponseCache</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">DEFAULT_RESPONSE_CACHE_SIZE</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">),</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;getChildren&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        // 保存初始配置字符串，可能用于后续配置恢复或重载。</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        this</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">initialConfig</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> initialConfig</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        // 初始化一个路径级别的请求度量收集器，用于监控不同路径的访问情况。</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        this</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">requestPathMetricsCollector</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> RequestPathMetricsCollector</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">()</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        // 调用方法初始化大请求限流设置，防止某些请求影响整体性能。</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        this</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">initLargeRequestThrottlingSettings</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    }</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_4-5-创建、启动adminserver-实例" tabindex="-1"><a class="header-anchor" href="#_4-5-创建、启动adminserver-实例"><span>4.5 创建、启动adminServer 实例</span></a></h2><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">            // Start Admin server</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">            adminServer </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> AdminServerFactory</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">createAdminServer</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">            adminServer</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">setZooKeeperServer</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(zkServer);</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">            adminServer</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">start</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这个东西我就不看了. 管理控制台</p><h2 id="_4-6-创建、启动-服务端网络连接工厂-servercnxnfactory" tabindex="-1"><a class="header-anchor" href="#_4-6-创建、启动-服务端网络连接工厂-servercnxnfactory"><span>4.6 创建、启动 服务端网络连接工厂 ServerCnxnFactory</span></a></h2><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">if</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> (</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">config</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getClientPortAddress</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> !=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> null</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">                // 服务端网络连接工厂， 默认是：NIOServerCnxnFactory，可以指定netty的实现 NettyServerCnxnFactory</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">                cnxnFactory </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> ServerCnxnFactory</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">createFactory</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">                cnxnFactory</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">configure</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">config</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getClientPortAddress</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(),</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">                        config</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getMaxClientCnxns</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(),</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">                        config</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getClientPortListenBacklog</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(),</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">                        false</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">                cnxnFactory</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">startup</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(zkServer);</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">                // zkServer has been started. So we don&#39;t need to start it again in secureCnxnFactory.</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">                needStartZKServer </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> false</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">            }</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>如果配置文件<code>zoo.cfg</code> 中配置了网络相关部分：如：<code>0.0.0.0:2181</code>则开始进行网络配置</li><li>初始化网络请求服务工厂类，默认是使用NIO，也可以通过参数：<code>zookeeper.serverCnxnFactory</code> 指定netty</li><li><h2 id="对服务端网络进行配置-cnxnfactory-configure" tabindex="-1"><a class="header-anchor" href="#对服务端网络进行配置-cnxnfactory-configure"><span>对服务端网络进行配置：cnxnFactory.configure</span></a></h2></li><li>启动网络服务 <ul><li>启动IO读取线程</li><li>accept线程</li><li>expire线程</li></ul></li><li>启动zkServer <ul><li>启动ZkDb，初始化或者加载本地数据到内存</li><li><strong>setupRequestProcessors 请求器链</strong><ul><li>PrepRequestProcessor：进行预处理，生成事务头zxid,日志记录等，读请求直接跳过，写请求必须被处理</li><li>SyncRequestProcessor：负责写事务日志</li><li>FinalRequestProcessor：响应数据给客户，更新内存树</li></ul></li><li>startRequestThrottler 限流器</li></ul></li></ul><hr><p>在一个典型的 ZooKeeper 请求处理流程中，这些处理器按照如下顺序协同工作：</p><ol><li><strong>PrepRequestProcessor</strong>首先接收到来自客户端的请求，并对其进行预处理，包括检查和生成必要的元数据。</li><li>然后，它将请求转发给<strong>SyncRequestProcessor</strong>，后者负责将所有相关的写操作安全地记录到磁盘上。</li><li>最后，经过同步处理的请求会被传递给<strong>FinalRequestProcessor</strong>，在这里完成最终的数据更新并将结果反馈给客户端。</li></ol><p>这种设计模式允许 ZooKeeper 实现高效且可靠的服务，同时保持良好的扩展性和性能。每种处理器专注于自己的职责，使得整个系统既灵活又强大。</p><hr><h2 id="_4-7-containermanager-znode容器管理者创建与启动" tabindex="-1"><a class="header-anchor" href="#_4-7-containermanager-znode容器管理者创建与启动"><span>4.7 ContainerManager：ZNode容器管理者创建与启动</span></a></h2><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">            containerManager </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> ContainerManager</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">                zkServer</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getZKDatabase</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(),</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">                zkServer</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">firstProcessor</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">                Integer</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getInteger</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;znode.container.checkIntervalMs&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, (</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">TimeUnit</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">MINUTES</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">toMillis</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)),</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">                Integer</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getInteger</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;znode.container.maxPerMinute&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">10000</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">                Long</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getLong</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;znode.container.maxNeverUsedIntervalMs&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">            )</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">            containerManager</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">start</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这个组件的代码狠简单，创建了一个Java的定时器timer，然后start的时候，创建了一个任务timerTask提交到timer中，定时循环执行，通过不断调用 <code>org.apache.zookeeper.server.ContainerManager#checkContainers</code> 达到清理的目的，而这个清理，又调用了</p><ul><li>清理目标：zkDb</li><li>清理手段：FinalRequestProcessor#processRequest</li></ul>`,53)]))}const r=s(l,[["render",t]]),d=JSON.parse('{"path":"/Java/zookeeper/2.Zookeeper%20server%E5%90%AF%E5%8A%A8.html","title":"2.Zookeeper server 启动","lang":"zh-CN","frontmatter":{"title":"2.Zookeeper server 启动","description":"zk 客户端工具：https://github.com/vran-dev/PrettyZoo/releases （已停止维护） 1. 拉起代码 GitHub 2. 导入idea 2.1 编译 导入idea之后，先不要进行启动代码，先进行编译一次： 2.2更新pom 更新 server 模块下的pom，因有些依赖的scope是provide，将其注释掉，...","head":[["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"2.Zookeeper server 启动\\",\\"image\\":[\\"\\"],\\"dateModified\\":\\"2025-08-04T08:05:24.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"heihei180\\",\\"url\\":\\"https://github.com/heihei180\\"}]}"],["meta",{"property":"og:url","content":"https://vuepress-theme-hope-docs-demo.netlify.app/note/Java/zookeeper/2.Zookeeper%20server%E5%90%AF%E5%8A%A8.html"}],["meta",{"property":"og:site_name","content":"筆記本首頁"}],["meta",{"property":"og:title","content":"2.Zookeeper server 启动"}],["meta",{"property":"og:description","content":"zk 客户端工具：https://github.com/vran-dev/PrettyZoo/releases （已停止维护） 1. 拉起代码 GitHub 2. 导入idea 2.1 编译 导入idea之后，先不要进行启动代码，先进行编译一次： 2.2更新pom 更新 server 模块下的pom，因有些依赖的scope是provide，将其注释掉，..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2025-08-04T08:05:24.000Z"}],["meta",{"property":"article:modified_time","content":"2025-08-04T08:05:24.000Z"}]]},"git":{"createdTime":1754294474000,"updatedTime":1754294724000,"contributors":[{"name":"wanggq10","username":"wanggq10","email":"wanggq10@lenovo.com","commits":2,"url":"https://github.com/wanggq10"}]},"readingTime":{"minutes":4.7,"words":1409},"filePathRelative":"Java/zookeeper/2.Zookeeper server启动.md","autoDesc":true}');export{r as comp,d as data};
