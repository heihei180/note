# 1.Ktorå¯åŠ¨
å† ktor çš„å¯åŠ¨ä¸­ï¼Œå¯åŠ¨å‡½æ•°æ˜¯è¿™ä¹ˆå†™çš„ï¼Ÿ

```ktolin
fun main(args: Array<String>): Unit =
    io.ktor.server.netty.EngineMain.main(args)
```

å³å¯åŠ¨å‡½æ•°å®é™…å§”æ‰˜æ‰§è¡Œ `EngineMain`çš„mainå‡½æ•°ã€‚

å¦å¤–ï¼Œè¿˜éœ€è¦æ³¨æ„çš„æ˜¯ï¼šé…ç½®æ–‡ä»¶ä¸­çš„å†™æ³•ï¼š

```text
ktor {
    deployment {
        port = 28080
        port = ${?PORT}
    }
    application {
        modules = [ io.ktor.samples.H2ApplicationKt.module ]
    }
}


```

ä¸çŸ¥é“å…·ä½“å®ç°ï¼Œä½†æ˜¯ä¼šå›è°ƒ è¿™ä¸ªåœ°æ–¹çš„ä»£ç ï¼š
å‡½æ•°çš„å…¨è·¯å¾„ï¼š
`  modules = [ io.ktor.samples.H2ApplicationKt.module ]`

## 2. å‡½æ•°çš„å¯åŠ¨

```kt

    @JvmStatic
    public fun main(args: Array<String>) {
        val server = createServer(args)
        server.start(true)
    }
```

- åˆ›å»º server 
- å¯åŠ¨ server

## 3. åˆ›å»ºserver

io.ktor.server.netty.EngineMain#createServer

```kt
    public fun createServer(
        args: Array<String>
    ): EmbeddedServer<NettyApplicationEngine, NettyApplicationEngine.Configuration> {
        val config = CommandLineConfig(args)
        return EmbeddedServer(config.rootConfig, Netty) {
            takeFrom(config.engineConfig)
            loadConfiguration(config.rootConfig.environment.config)
        }
    }
```

- typealias ç±»å‹åˆ«å
- suspend Application.() -> Unit å¸¦æ¥æ”¶è€…çš„ suspend lambda
- actual Kotlin å¤šå¹³å°å®ç°æœºåˆ¶
- actual constructor ä¸»æ„é€ å™¨
kt é«˜é˜¶ç”¨æ³•ã€‚éœ€è¦ç ”ç©¶æ˜ç™½è¿™äº›è¯­æ³•ã€‚



`EmbeddedServer(config.rootConfig, Netty)` 
åˆ›å»ºä¸€ä¸ªnetty serverï¼Œå‰é¢æ˜¯ root configï¼Œ ä¸­é—´æ˜¯æœåŠ¡å™¨ç±»å‹ï¼Œæœ€åä¸€ä¸ªå‚æ•°æ˜¯åŠ è½½å‚æ•°ï¼š

```kt
internal fun NettyApplicationEngine.Configuration.loadConfiguration(config: ApplicationConfig) {
        val deploymentConfig = config.config("ktor.deployment")
        loadCommonConfiguration(deploymentConfig)
        deploymentConfig.propertyOrNull("runningLimit")?.getString()?.toInt()?.let {
            runningLimit = it
        }
        deploymentConfig.propertyOrNull("shareWorkGroup")?.getString()?.toBoolean()?.let {
            shareWorkGroup = it
        }
        deploymentConfig.propertyOrNull("responseWriteTimeoutSeconds")?.getString()?.toInt()?.let {
            responseWriteTimeoutSeconds = it
        }
        deploymentConfig.propertyOrNull("requestReadTimeoutSeconds")?.getString()?.toInt()?.let {
            requestReadTimeoutSeconds = it
        }
        deploymentConfig.propertyOrNull("tcpKeepAlive")?.getString()?.toBoolean()?.let {
            tcpKeepAlive = it
        }
        deploymentConfig.propertyOrNull("maxInitialLineLength")?.getString()?.toInt()?.let {
            maxInitialLineLength = it
        }
        deploymentConfig.propertyOrNull("maxHeaderSize")?.getString()?.toInt()?.let {
            maxHeaderSize = it
        }
        deploymentConfig.propertyOrNull("maxChunkSize")?.getString()?.toInt()?.let {
            maxChunkSize = it
        }
        deploymentConfig.propertyOrNull("enableHttp2")?.getString()?.toBoolean()?.let {
            enableHttp2 = it
        }
        deploymentConfig.propertyOrNull("enableH2c")?.getString()?.toBoolean()?.let {
            enableH2c = it
        }
    }
```
è¿™ä¸ªå‡½æ•°ä¼šä» è§£æ application.confä¸­å…³äº ktorçš„é…ç½®ã€‚å¹¶åŠ è½½ã€‚


## 4. å¯åŠ¨ server

```kt
  server.start(true)
```

io.ktor.server.engine.EmbeddedServer#start

```kt
public actual fun start(wait: Boolean): EmbeddedServer<TEngine, TConfiguration> {

        // æ·»åŠ é’©å­å‡½æ•°
        addShutdownHook { stop() }

        // è¯»å†™é” è·å–å†™é”
        applicationInstanceLock.write {
            val (application, classLoader) = try {
                // åˆ›å»ºapplication
                createApplication()
            } catch (cause: Throwable) {
                // é”€æ¯ application
                destroyApplication()
                if (watchPatterns.isNotEmpty()) {
                    cleanupWatcher()
                }

                throw cause
            }
            applicationInstance = application
            applicationClassLoader = classLoader
        }

        //  ç¬¬ä¸‰æ­¥ï¼šå¼‚æ­¥æ‰“å°æœåŠ¡å™¨ç›‘å¬åœ°å€
        CoroutineScope(application.coroutineContext).launch {
            engine.resolvedConnectors().forEach {
                val host = escapeHostname(it.host)
                environment.log.info(
                    "Responding at ${it.type.name.lowercase()}://$host:${it.port}"
                )
            }
        }

        engine.start(wait)
        return this
    }
```

1. applicationInstanceLock.write { ... }
   1. ä½¿ç”¨ ReentrantReadWriteLock çš„å†™é”ï¼Œç¡®ä¿å¤šçº¿ç¨‹ç¯å¢ƒä¸‹å®‰å…¨åœ°åˆå§‹åŒ–/é‡å»ºåº”ç”¨å®ä¾‹ï¼ˆå°¤å…¶åœ¨å¼€å‘æ¨¡å¼ä¸‹çƒ­é‡è½½æ—¶ï¼‰ã€‚
2. createApplication()
   1. åˆ›å»º Application å¯¹è±¡ï¼ˆKtor åº”ç”¨çš„æ ¸å¿ƒä¸Šä¸‹æ–‡ï¼‰ã€‚
   2. åœ¨å¼€å‘æ¨¡å¼ä¸‹ï¼Œè¿˜ä¼šè®¾ç½®è‡ªå®šä¹‰ç±»åŠ è½½å™¨ï¼ˆOverridingClassLoaderï¼‰ï¼Œç”¨äºç›‘å¬ä»£ç å˜æ›´å¹¶çƒ­é‡è½½ã€‚
3. å¼‚å¸¸å¤„ç†
   1. å¦‚æœåˆ›å»ºå¤±è´¥ï¼ˆå¦‚æ¨¡å—åŠ è½½é”™è¯¯ï¼‰ï¼Œå…ˆæ¸…ç†å·²åˆ†é…çš„èµ„æºï¼ˆdestroyApplication()ã€cleanupWatcher()ï¼‰ï¼Œå†æŠ›å‡ºå¼‚å¸¸
   2. é¿å…â€œåŠå¯åŠ¨â€çŠ¶æ€å¯¼è‡´èµ„æºæ³„æ¼ã€‚
4. ä¿å­˜å®ä¾‹
   1. å°†æ–°åˆ›å»ºçš„ application å’Œ classLoader å­˜å…¥æˆå‘˜å˜é‡ï¼Œä¾›åç»­è¯·æ±‚ä½¿ç”¨ã€‚

**ç¬¬ä¸‰æ­¥ï¼šå¼‚æ­¥æ‰“å°æœåŠ¡å™¨ç›‘å¬åœ°å€**

1. ä¸ºä»€ä¹ˆç”¨ launchï¼Ÿ
  - engine.start(wait) å¯èƒ½ä¼šé˜»å¡ï¼ˆå½“ wait=trueï¼‰ï¼Œä½†æˆ‘ä»¬å¸Œæœ›å°½å¿«æ‰“å°æ—¥å¿—ï¼Œæ‰€ä»¥ç”¨åç¨‹å¼‚æ­¥æ‰§è¡Œã€‚
  - å³ä½¿ä¸»çº¿ç¨‹è¢« engine.start(true) é˜»å¡ï¼Œæ—¥å¿—ä¹Ÿèƒ½åŠæ—¶è¾“å‡ºã€‚
2. resolvedConnectors()
   1. è·å–æœåŠ¡å™¨å®é™…ç»‘å®šçš„åè®®ï¼ˆHTTP/HTTPSï¼‰ã€ä¸»æœºå’Œç«¯å£ã€‚
   2. ä¾‹å¦‚ï¼š[Connector(HTTP, "0.0.0.0", 8080)]

**ç¬¬å››æ­¥ï¼šå¯åŠ¨åº•å±‚å¼•æ“**

```kotlin
 ç¬¬å››æ­¥ï¼šå¯åŠ¨åº•å±‚å¼•æ“
```

- è°ƒç”¨å…·ä½“å¼•æ“ï¼ˆå¦‚ Nettyã€Tomcatï¼‰çš„ start æ–¹æ³•ã€‚
- è¡Œä¸ºå–å†³äº wait å‚æ•°ï¼š
  - wait = trueï¼šé˜»å¡å½“å‰çº¿ç¨‹ï¼Œç›´åˆ°æœåŠ¡å™¨åœæ­¢ï¼ˆé€šå¸¸ç”¨äºä¸»å‡½æ•°ï¼‰ã€‚
  - wait = falseï¼šå¯åŠ¨åç«‹å³è¿”å›ï¼ŒæœåŠ¡å™¨åœ¨åå°çº¿ç¨‹è¿è¡Œã€‚




### ğŸ§  æ•´ä½“æµç¨‹æ€»ç»“
| æ­¥éª¤ | åŠ¨ä½œ | ç›®çš„ |
|------|------|------|
| 1 | æ³¨å†Œå…³é—­é’©å­ | ç¡®ä¿ JVM é€€å‡ºæ—¶ä¼˜é›…å…³é—­æœåŠ¡å™¨ |
| 2 | åŠ é”åˆ›å»º `Application` | å®‰å…¨åˆå§‹åŒ–åº”ç”¨ä¸Šä¸‹æ–‡ï¼ˆæ”¯æŒçƒ­é‡è½½ï¼‰ |
| 3 | å¼‚æ­¥æ‰“å°ç›‘å¬åœ°å€ | å¿«é€Ÿåé¦ˆæœåŠ¡å™¨å¯åŠ¨ä¿¡æ¯ |
| 4 | å¯åŠ¨åº•å±‚å¼•æ“ | çœŸæ­£å¼€å§‹ç›‘å¬ HTTP è¯·æ±‚ |
| 5 | è¿”å› `this` | æ”¯æŒé“¾å¼è°ƒç”¨ |




