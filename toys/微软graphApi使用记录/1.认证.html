<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>认证 | Heihei&#39;s Blog</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="LIVE FOR LIVE">
    
    <link rel="preload" href="/note/assets/css/0.styles.ba751174.css" as="style"><link rel="preload" href="/note/assets/js/app.886f9803.js" as="script"><link rel="preload" href="/note/assets/js/2.94ba4297.js" as="script"><link rel="preload" href="/note/assets/js/1.b1c00c21.js" as="script"><link rel="preload" href="/note/assets/js/134.94a942ad.js" as="script"><link rel="prefetch" href="/note/assets/js/10.15312de4.js"><link rel="prefetch" href="/note/assets/js/100.c8469e4d.js"><link rel="prefetch" href="/note/assets/js/101.a6ead17d.js"><link rel="prefetch" href="/note/assets/js/102.26f309d8.js"><link rel="prefetch" href="/note/assets/js/103.c01acce4.js"><link rel="prefetch" href="/note/assets/js/104.5ed63c1d.js"><link rel="prefetch" href="/note/assets/js/105.e0c8b135.js"><link rel="prefetch" href="/note/assets/js/106.b740710e.js"><link rel="prefetch" href="/note/assets/js/107.d579492a.js"><link rel="prefetch" href="/note/assets/js/108.8c57c3cc.js"><link rel="prefetch" href="/note/assets/js/109.c724749c.js"><link rel="prefetch" href="/note/assets/js/11.d9e1af3e.js"><link rel="prefetch" href="/note/assets/js/110.bae633be.js"><link rel="prefetch" href="/note/assets/js/111.78127a75.js"><link rel="prefetch" href="/note/assets/js/112.a1f07bb0.js"><link rel="prefetch" href="/note/assets/js/113.37b9fa03.js"><link rel="prefetch" href="/note/assets/js/114.06552686.js"><link rel="prefetch" href="/note/assets/js/115.9274a2de.js"><link rel="prefetch" href="/note/assets/js/116.c179eb65.js"><link rel="prefetch" href="/note/assets/js/117.9c546ab5.js"><link rel="prefetch" href="/note/assets/js/118.a1d05bb0.js"><link rel="prefetch" href="/note/assets/js/119.999f533e.js"><link rel="prefetch" href="/note/assets/js/12.76775932.js"><link rel="prefetch" href="/note/assets/js/120.a30accfa.js"><link rel="prefetch" href="/note/assets/js/121.b8373510.js"><link rel="prefetch" href="/note/assets/js/122.b9248c8d.js"><link rel="prefetch" href="/note/assets/js/123.63eeb320.js"><link rel="prefetch" href="/note/assets/js/124.8ece7656.js"><link rel="prefetch" href="/note/assets/js/125.c8af5eb1.js"><link rel="prefetch" href="/note/assets/js/126.d2be357d.js"><link rel="prefetch" href="/note/assets/js/127.0fb45185.js"><link rel="prefetch" href="/note/assets/js/128.df4a5227.js"><link rel="prefetch" href="/note/assets/js/129.525d898d.js"><link rel="prefetch" href="/note/assets/js/13.4fc1b5bc.js"><link rel="prefetch" href="/note/assets/js/130.27af0c30.js"><link rel="prefetch" href="/note/assets/js/131.05b78c1d.js"><link rel="prefetch" href="/note/assets/js/132.a4a2af81.js"><link rel="prefetch" href="/note/assets/js/133.10213234.js"><link rel="prefetch" href="/note/assets/js/135.25df9b0b.js"><link rel="prefetch" href="/note/assets/js/136.71d5a4a3.js"><link rel="prefetch" href="/note/assets/js/137.f12badbc.js"><link rel="prefetch" href="/note/assets/js/138.6a98f94a.js"><link rel="prefetch" href="/note/assets/js/139.dd7c2181.js"><link rel="prefetch" href="/note/assets/js/14.703895ae.js"><link rel="prefetch" href="/note/assets/js/140.8dbca65d.js"><link rel="prefetch" href="/note/assets/js/141.16eeade4.js"><link rel="prefetch" href="/note/assets/js/142.a591591b.js"><link rel="prefetch" href="/note/assets/js/143.dc81cb10.js"><link rel="prefetch" href="/note/assets/js/144.7f8c1f5c.js"><link rel="prefetch" href="/note/assets/js/145.a1472a1e.js"><link rel="prefetch" href="/note/assets/js/146.bc7a3621.js"><link rel="prefetch" href="/note/assets/js/147.58617a31.js"><link rel="prefetch" href="/note/assets/js/15.857f3c68.js"><link rel="prefetch" href="/note/assets/js/16.7f30f79b.js"><link rel="prefetch" href="/note/assets/js/17.8b7b7146.js"><link rel="prefetch" href="/note/assets/js/18.24a37b58.js"><link rel="prefetch" href="/note/assets/js/19.cb6695f4.js"><link rel="prefetch" href="/note/assets/js/20.bf16d45f.js"><link rel="prefetch" href="/note/assets/js/21.f426c9f9.js"><link rel="prefetch" href="/note/assets/js/22.ba9a5c54.js"><link rel="prefetch" href="/note/assets/js/23.f43dffab.js"><link rel="prefetch" href="/note/assets/js/24.1b94a916.js"><link rel="prefetch" href="/note/assets/js/25.d3ab7592.js"><link rel="prefetch" href="/note/assets/js/26.f66699ce.js"><link rel="prefetch" href="/note/assets/js/27.a808e619.js"><link rel="prefetch" href="/note/assets/js/28.fb6254ad.js"><link rel="prefetch" href="/note/assets/js/29.e81f8f6c.js"><link rel="prefetch" href="/note/assets/js/3.4807bea2.js"><link rel="prefetch" href="/note/assets/js/30.362cb710.js"><link rel="prefetch" href="/note/assets/js/31.fd914435.js"><link rel="prefetch" href="/note/assets/js/32.e979e99b.js"><link rel="prefetch" href="/note/assets/js/33.9cce4536.js"><link rel="prefetch" href="/note/assets/js/34.d529f1a2.js"><link rel="prefetch" href="/note/assets/js/35.07c9ef1d.js"><link rel="prefetch" href="/note/assets/js/36.9eb0dc70.js"><link rel="prefetch" href="/note/assets/js/37.b496a8f1.js"><link rel="prefetch" href="/note/assets/js/38.ad477100.js"><link rel="prefetch" href="/note/assets/js/39.5ef0e9a6.js"><link rel="prefetch" href="/note/assets/js/4.4c5e732a.js"><link rel="prefetch" href="/note/assets/js/40.dade1616.js"><link rel="prefetch" href="/note/assets/js/41.1cf9246e.js"><link rel="prefetch" href="/note/assets/js/42.55ab599f.js"><link rel="prefetch" href="/note/assets/js/43.758ed236.js"><link rel="prefetch" href="/note/assets/js/44.bf60c5f4.js"><link rel="prefetch" href="/note/assets/js/45.d0622431.js"><link rel="prefetch" href="/note/assets/js/46.bddb180e.js"><link rel="prefetch" href="/note/assets/js/47.fc5defa6.js"><link rel="prefetch" href="/note/assets/js/48.c55fa070.js"><link rel="prefetch" href="/note/assets/js/49.cb632f26.js"><link rel="prefetch" href="/note/assets/js/5.865a78de.js"><link rel="prefetch" href="/note/assets/js/50.7be16540.js"><link rel="prefetch" href="/note/assets/js/51.d3c5c2b7.js"><link rel="prefetch" href="/note/assets/js/52.f620868f.js"><link rel="prefetch" href="/note/assets/js/53.ccde6e28.js"><link rel="prefetch" href="/note/assets/js/54.654ac1a5.js"><link rel="prefetch" href="/note/assets/js/55.fcbb0ffa.js"><link rel="prefetch" href="/note/assets/js/56.67d5532d.js"><link rel="prefetch" href="/note/assets/js/57.e3da55f4.js"><link rel="prefetch" href="/note/assets/js/58.2e2af300.js"><link rel="prefetch" href="/note/assets/js/59.e12ee953.js"><link rel="prefetch" href="/note/assets/js/6.7e009155.js"><link rel="prefetch" href="/note/assets/js/60.d70314c8.js"><link rel="prefetch" href="/note/assets/js/61.6d691b0f.js"><link rel="prefetch" href="/note/assets/js/62.323a06a4.js"><link rel="prefetch" href="/note/assets/js/63.baed8bdb.js"><link rel="prefetch" href="/note/assets/js/64.94b237da.js"><link rel="prefetch" href="/note/assets/js/65.b88972e1.js"><link rel="prefetch" href="/note/assets/js/66.dbfeb40e.js"><link rel="prefetch" href="/note/assets/js/67.e12147cd.js"><link rel="prefetch" href="/note/assets/js/68.221fdfdc.js"><link rel="prefetch" href="/note/assets/js/69.df1bf77b.js"><link rel="prefetch" href="/note/assets/js/7.a79d152b.js"><link rel="prefetch" href="/note/assets/js/70.6859f064.js"><link rel="prefetch" href="/note/assets/js/71.77c0c99a.js"><link rel="prefetch" href="/note/assets/js/72.c27a44e6.js"><link rel="prefetch" href="/note/assets/js/73.1018f84c.js"><link rel="prefetch" href="/note/assets/js/74.0732851a.js"><link rel="prefetch" href="/note/assets/js/75.144a5e90.js"><link rel="prefetch" href="/note/assets/js/76.0e2457f9.js"><link rel="prefetch" href="/note/assets/js/77.b423f058.js"><link rel="prefetch" href="/note/assets/js/78.4cdc87a0.js"><link rel="prefetch" href="/note/assets/js/79.e4b02604.js"><link rel="prefetch" href="/note/assets/js/80.1281df18.js"><link rel="prefetch" href="/note/assets/js/81.6b5efd69.js"><link rel="prefetch" href="/note/assets/js/82.fc5e2955.js"><link rel="prefetch" href="/note/assets/js/83.e88dc2c0.js"><link rel="prefetch" href="/note/assets/js/84.5603c719.js"><link rel="prefetch" href="/note/assets/js/85.3bce707f.js"><link rel="prefetch" href="/note/assets/js/86.972e829c.js"><link rel="prefetch" href="/note/assets/js/87.522fdb03.js"><link rel="prefetch" href="/note/assets/js/88.2083c776.js"><link rel="prefetch" href="/note/assets/js/89.b9fe4c43.js"><link rel="prefetch" href="/note/assets/js/90.56fa38aa.js"><link rel="prefetch" href="/note/assets/js/91.46fdaf09.js"><link rel="prefetch" href="/note/assets/js/92.7385bcb7.js"><link rel="prefetch" href="/note/assets/js/93.ffc989e2.js"><link rel="prefetch" href="/note/assets/js/94.ef5cc52d.js"><link rel="prefetch" href="/note/assets/js/95.d39ba460.js"><link rel="prefetch" href="/note/assets/js/96.e6980c63.js"><link rel="prefetch" href="/note/assets/js/97.cb538761.js"><link rel="prefetch" href="/note/assets/js/98.97aa4f62.js"><link rel="prefetch" href="/note/assets/js/99.afdd0071.js"><link rel="prefetch" href="/note/assets/js/vendors~docsearch.62348aea.js">
    <link rel="stylesheet" href="/note/assets/css/0.styles.ba751174.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/note/" class="home-link router-link-active"><!----> <span class="site-name">Heihei's Blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/note/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/note/guide/" class="nav-link">
  Guide
</a></div><div class="nav-item"><a href="https://baidu.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  External
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/note/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/note/guide/" class="nav-link">
  Guide
</a></div><div class="nav-item"><a href="https://baidu.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  External
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/note/" aria-current="page" class="sidebar-link">Home</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Guide</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>面试</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Python</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>C#</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>CPP</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>toys</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>微软graphApi使用记录</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/note/toys/微软graphApi使用记录/1.认证.html" class="active sidebar-link">认证</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note/toys/微软graphApi使用记录/1.认证.html#官网demo" class="sidebar-link">官网demo</a></li><li class="sidebar-sub-header"><a href="/note/toys/微软graphApi使用记录/1.认证.html#返回响应解释" class="sidebar-link">返回响应解释</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>油猴脚本</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/note/toys/玩具.html" class="sidebar-link">页面说明</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="认证"><a href="#认证" class="header-anchor">#</a> 认证</h1> <p>只介绍账号密码登录获取Token的方式</p> <h2 id="官网demo"><a href="#官网demo" class="header-anchor">#</a> 官网demo</h2> <div class="language-text extra-class"><pre class="language-text"><code>origin  https://github.com/Azure-Samples/ms-identity-msal-java-samples.git (fetch)
origin  https://github.com/Azure-Samples/ms-identity-msal-java-samples.git (push)

</code></pre></div><ul><li>进入 <code>client-side</code> ， 选择 <code>Username-Password-Flow</code></li> <li>这是一个标准的maven项目，进入<code>SRC</code></li> <li>修改配置文件</li></ul> <p>下面配置信息，需要先去ms axure 上申请设置</p> <div class="language-properties extra-class"><pre class="language-properties"><code>
<span class="token key attr-name">CLIENT_ID</span><span class="token punctuation">=</span><span class="token value attr-value">a416354d-83a7*********</span>
<span class="token key attr-name">USER_NAME</span><span class="token punctuation">=</span><span class="token value attr-value">你的用户名（邮箱地址）</span>
<span class="token key attr-name">USER_PASSWORD</span><span class="token punctuation">=</span><span class="token value attr-value">你的密码</span>
<span class="token comment"># The below properties do not need to be changed for this sample</span>
<span class="token comment"># In a real situation they would be used to affect authentication behavior, such as changing where token requests are</span>
<span class="token comment"># sent by using a different authority URL</span>
<span class="token key attr-name">AUTHORITY</span><span class="token punctuation">=</span><span class="token value attr-value">https://login.microsoftonline.com/租户ID/oauth2/v2.0/token</span>
<span class="token key attr-name">SCOPE</span><span class="token punctuation">=</span><span class="token value attr-value">user.read</span>

</code></pre></div><ul><li>之后运行代码：<code>UsernamePasswordFlow#main</code> 可以得到token</li></ul> <blockquote><p>需要注意的是：账号密码获取token，需要开启一个配置： allow public client flows, 参考文档如下：
https://learn.microsoft.com/en-us/answers/questions/1539386/use-java-sdk-call-graph-api-with-aadsts7000218-err<br>
https://blog.csdn.net/arthas777/article/details/132048620
当然，这个方式只适合读取office365的邮件，如果不是，那么读取不了。</p></blockquote> <blockquote><p>以下所有请求都需要添加请求头， Authorization=上面获取的token</p></blockquote> <h1 id="读取邮箱中所有邮件"><a href="#读取邮箱中所有邮件" class="header-anchor">#</a> 读取邮箱中所有邮件</h1> <p><code>https://graph.microsoft.com/v1.0/me/mailFolders('Inbox')/messages??$select=sender,subject,isRead</code></p> <p>url 也可以替换如下：</p> <ul><li>/me/mailFolders('Inbox')/messages?$sender,subject,isRead</li> <li>/userId/mailFolders('folderId')/messages?$sender,subject,isRead</li></ul> <p>参数解释：</p> <ul><li>?$select=sender,subject,isRead： 意思是查询的列表中只获取邮件中的这几个属性</li></ul> <p>以上API参考：https://learn.microsoft.com/zh-cn/graph/api/mailfolder-list-messages?view=graph-rest-1.0&amp;tabs=java#code-try-1</p> <h2 id="返回响应解释"><a href="#返回响应解释" class="header-anchor">#</a> 返回响应解释</h2> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;@odata.context&quot;</span><span class="token operator">:</span> <span class="token string">&quot;https://graph.microsoft.com/v1.0/$metadata#users('2f***')/mailFolders('Inbox')/messages(sender,subject,isRead)&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;value&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token property">&quot;@odata.etag&quot;</span><span class="token operator">:</span> <span class="token string">&quot;W/\&quot;CKKBN5\&quot;&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;AAMzyAAA=&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;subject&quot;</span><span class="token operator">:</span> <span class="token string">&quot;[Gig Story]  跨部门协作 创新AI未来 | Innovate the future of AI through cross-org collaboration &quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;isRead&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
            <span class="token property">&quot;sender&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token property">&quot;emailAddress&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                    <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Legs&quot;</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;address&quot;</span><span class="token operator">:</span> <span class="token string">&quot;les@leo.com&quot;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            <span class="token property">&quot;@odata.etag&quot;</span><span class="token operator">:</span> <span class="token string">&quot;W/F5\&quot;&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;AAMkADNoRMxUyxAAA=&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;subject&quot;</span><span class="token operator">:</span> <span class="token string">&quot;[Sur]平台工程用户满意度调研&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;isRead&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
            <span class="token property">&quot;sender&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token property">&quot;emailAddress&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                    <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Developer Community&quot;</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;address&quot;</span><span class="token operator">:</span> <span class="token string">&quot;developers@lo.com&quot;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;@odata.nextLink&quot;</span><span class="token operator">:</span> <span class="token string">&quot;https://graph.microsoft.com/v1.0/me/mailFolders('Inbox')/messages?%24select=sender%2csubject%2cisRead&amp;%24top=10&amp;%24skip=10&quot;</span>
<span class="token punctuation">}</span>

</code></pre></div><ul><li>odata.context： 当前请求地址</li> <li>value 邮件列表
<ul><li>id： 邮件id</li> <li>subject： 邮件主题</li> <li>isRead： 邮件是否读取标志</li> <li>sender： 发件人信息</li></ul></li> <li>@odata.nextLink： 下一条消息请求地址</li></ul> <p>可以对比以下，我们请求的地址和ms返回的当前请求地址和吓一跳消息地址略有不同</p> <ul><li>https://graph.microsoft.com/v1.0/me/mailFolders('Inbox')/messages?$select=sender,subject,isRead</li> <li>https://graph.microsoft.com/v1.0/$metadata#users('2fe3e6ce')/mailFolders('Inbox')/messages(sender,subject,isRead)</li> <li>https://graph.microsoft.com/v1.0/me/mailFolders('Inbox')/messages?%24select=sender%2csubject%2cisRead&amp;%24top=10&amp;%24skip=10</li></ul> <p>区别就是 me 可以 替换成userId,也可以写成 user('用户id') 的方式
folderId 可以使用id 也可以 mailFolders('Inbox')
反正使用一种就可以了。</p> <p>还有就是吓一跳连接 多了两个参数： &amp;$top=10&amp;$skip=10
其实就是分页参数 所以当你想要访问首页的时候，参数可以设置为：$top=10&amp;$skip=0
第二页：$top=10&amp;$skip=10
第三页：$top=10&amp;$skip=20</p> <h1 id="获取所有文件夹"><a href="#获取所有文件夹" class="header-anchor">#</a> 获取所有文件夹</h1> <ul><li>https://graph.microsoft.com/v1.0/users/用户id/mailFolders?skip=0</li></ul> <p>官方文档：https://learn.microsoft.com/zh-cn/graph/api/user-list-mailfolders?view=graph-rest-1.0&amp;tabs=http</p> <p>注意返回值中的下条数据地址：&quot;@odata.nextLink&quot;: &quot;https://graph.microsoft.com/v1.0/users/2feba56f-7d67-408f-a254-309ffa23e6ce/mailFolders?%24skip=10&quot;</p> <p>这里是 skip, 和上面的分页参数是不一样的。</p> <h1 id="指定文件夹中的所有消息"><a href="#指定文件夹中的所有消息" class="header-anchor">#</a> 指定文件夹中的所有消息</h1> <blockquote><p>这个貌似和上面的一样了</p></blockquote> <ul><li>https://learn.microsoft.com/zh-cn/graph/api/user-list-messages?view=graph-rest-1.0&amp;tabs=http</li> <li>https://graph.microsoft.com/v1.0/users/用户id/mailFolders/文件夹id/messages</li></ul> <h1 id="查看邮件详情"><a href="#查看邮件详情" class="header-anchor">#</a> 查看邮件详情</h1> <ul><li>https://graph.microsoft.com/v1.0/users/用户id/mailFolders/文件夹ID/messages/消息ID</li> <li>https://learn.microsoft.com/zh-cn/graph/api/mailfolder-list-messages?view=graph-rest-1.0&amp;tabs=java#code-try-1</li></ul> <h1 id="修改邮件"><a href="#修改邮件" class="header-anchor">#</a> 修改邮件</h1> <ul><li>https://learn.microsoft.com/zh-cn/graph/api/message-update?view=graph-rest-1.0&amp;tabs=http</li></ul> <p>PATCH : https://graph.microsoft.com/v1.0/users/用户ID/mailFolders/文件夹iD/messages/消息ID
request body:</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;isRead&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>
</code></pre></div><p>代表将邮件中的isRead 属性改成true，代表当前邮件已读。
注意请求方式使用patch</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * office 365 client, use for call ms graph api
 */</span>
<span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;office365GraphClient&quot;</span><span class="token punctuation">,</span> url <span class="token operator">=</span> <span class="token string">&quot;https://graph.microsoft.com/v1.0&quot;</span>
        <span class="token punctuation">,</span> configuration <span class="token operator">=</span> <span class="token class-name">Office365ClientConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span>
<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Office365Client</span> <span class="token punctuation">{</span>


    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/me&quot;</span><span class="token punctuation">)</span>
    <span class="token class-name">MsUserInfoDTO</span> <span class="token function">me</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>path <span class="token operator">=</span> <span class="token string">&quot;/users/{id}/mailFolders?skip={size}&quot;</span><span class="token punctuation">)</span>
    <span class="token class-name">OfficeFolderDTO</span> <span class="token function">folders</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> id<span class="token punctuation">,</span> <span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;size&quot;</span><span class="token punctuation">)</span> <span class="token keyword">int</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>path <span class="token operator">=</span> <span class="token string">&quot;/users/{userId}/mailFolders/{folderId}/messages/?%24top={top}&amp;%24skip={skip}&quot;</span><span class="token punctuation">)</span>
    <span class="token class-name">EmailDTO</span> <span class="token function">emails</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;userId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> id<span class="token punctuation">,</span> <span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;folderId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> folderId<span class="token punctuation">,</span>
                    <span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;top&quot;</span><span class="token punctuation">)</span> <span class="token keyword">int</span> top<span class="token punctuation">,</span>
                    <span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;skip&quot;</span><span class="token punctuation">)</span> <span class="token keyword">int</span> skip<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 标记已读</span>
    <span class="token annotation punctuation">@PatchMapping</span><span class="token punctuation">(</span>path <span class="token operator">=</span> <span class="token string">&quot;/users/{userId}/mailFolders/{folderId}/messages/{messageId}&quot;</span><span class="token punctuation">)</span>
    <span class="token class-name">EmailDTO</span> <span class="token function">markAsRead</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;userId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> userId<span class="token punctuation">,</span>
                        <span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;folderId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> folderId<span class="token punctuation">,</span>
                        <span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;messageId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> messageId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><h1 id="office365clientconfiguration-java"><a href="#office365clientconfiguration-java" class="header-anchor">#</a> Office365ClientConfiguration.java</h1> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>microsoft<span class="token punctuation">.</span>aad<span class="token punctuation">.</span>msal4j<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">feign<span class="token punctuation">.</span></span><span class="token class-name">RequestInterceptor</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">feign<span class="token punctuation">.</span></span><span class="token class-name">RequestTemplate</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Logger</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">LoggerFactory</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">RedisTemplate</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">StringRedisTemplate</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">ValueOperations</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">Instant</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span>temporal<span class="token punctuation">.</span></span><span class="token class-name">ChronoUnit</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Collections</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Set</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">TimeUnit</span></span><span class="token punctuation">;</span>


<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Office365ClientConfiguration</span> <span class="token keyword">implements</span> <span class="token class-name">RequestInterceptor</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> log <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">Office365ClientConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">StringRedisTemplate</span> redisTemplate <span class="token operator">=</span> <span class="token class-name">ApplicationContextUtil</span><span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token class-name">StringRedisTemplate</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">String</span> cacheKey <span class="token operator">=</span> <span class="token class-name">RedisConstant</span><span class="token punctuation">.</span><span class="token constant">OFFICE_365_TOKEN</span><span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">apply</span><span class="token punctuation">(</span><span class="token class-name">RequestTemplate</span> requestTemplate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> url <span class="token operator">=</span> requestTemplate<span class="token punctuation">.</span><span class="token function">feignTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">url</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>url<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">&quot;graph.microsoft.com&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                requestTemplate<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">&quot;Authorization&quot;</span><span class="token punctuation">,</span> <span class="token function">getToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;获取office365 token失败&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ManagedServiceException</span><span class="token punctuation">(</span><span class="token string">&quot;获取office365 token失败&quot;</span><span class="token operator">+</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>



    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">ValueOperations</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> ops <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> token <span class="token operator">=</span> ops<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtil</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token class-name">IAuthenticationResult</span> authResult <span class="token operator">=</span> <span class="token function">auth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            token <span class="token operator">=</span> authResult<span class="token punctuation">.</span><span class="token function">accessToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Instant</span> expireTime <span class="token operator">=</span> authResult<span class="token punctuation">.</span><span class="token function">expiresOnDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toInstant</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">long</span> duration <span class="token operator">=</span> <span class="token class-name">ChronoUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">.</span><span class="token function">between</span><span class="token punctuation">(</span><span class="token class-name">Instant</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> expireTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
            ops<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">,</span> token<span class="token punctuation">,</span> duration<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> token<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getTokenFromCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">RedisTemplate</span> redisTemplate <span class="token operator">=</span> <span class="token class-name">ApplicationContextUtil</span><span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token class-name">RedisTemplate</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ValueOperations</span> ops <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> authority<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> scope<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> clientId<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> username<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> password<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">IAuthenticationResult</span> <span class="token function">auth</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>

        <span class="token function">setUpSampleData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">PublicClientApplication</span> pca <span class="token operator">=</span> <span class="token class-name">PublicClientApplication</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>clientId<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">authority</span><span class="token punctuation">(</span>authority<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//Get list of accounts from the application's token cache, and search them for the configured username</span>
        <span class="token comment">//getAccounts() will be empty on this first call, as accounts are added to the cache when acquiring a token</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">IAccount</span><span class="token punctuation">&gt;</span></span> accountsInCache <span class="token operator">=</span> pca<span class="token punctuation">.</span><span class="token function">getAccounts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">IAccount</span> account <span class="token operator">=</span> <span class="token function">getAccountByUsername</span><span class="token punctuation">(</span>accountsInCache<span class="token punctuation">,</span> username<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//Attempt to acquire token when user's account is not in the application's token cache</span>
        <span class="token class-name">IAuthenticationResult</span> result <span class="token operator">=</span> <span class="token function">acquireTokenUsernamePassword</span><span class="token punctuation">(</span>pca<span class="token punctuation">,</span> scope<span class="token punctuation">,</span> account<span class="token punctuation">,</span> username<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Account username: &quot;</span> <span class="token operator">+</span> result<span class="token punctuation">.</span><span class="token function">account</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">username</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Access token:     &quot;</span> <span class="token operator">+</span> result<span class="token punctuation">.</span><span class="token function">accessToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Id token:         &quot;</span> <span class="token operator">+</span> result<span class="token punctuation">.</span><span class="token function">idToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//        accountsInCache = pca.getAccounts().join();</span>
<span class="token comment">//        account = getAccountByUsername(accountsInCache, username);</span>
<span class="token comment">//</span>
<span class="token comment">//        //Attempt to acquire token again, now that the user's account and a token are in the application's token cache</span>
<span class="token comment">//        result = acquireTokenUsernamePassword(pca, scope, account, username, password);</span>
<span class="token comment">//        System.out.println(&quot;Account username: &quot; + result.account().username());</span>
<span class="token comment">//        System.out.println(&quot;Access token:     &quot; + result.accessToken());</span>
<span class="token comment">//        System.out.println(&quot;Id token:         &quot; + result.idToken());</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">IAuthenticationResult</span> <span class="token function">acquireTokenUsernamePassword</span><span class="token punctuation">(</span><span class="token class-name">PublicClientApplication</span> pca<span class="token punctuation">,</span>
                                                                      <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> scope<span class="token punctuation">,</span>
                                                                      <span class="token class-name">IAccount</span> account<span class="token punctuation">,</span>
                                                                      <span class="token class-name">String</span> username<span class="token punctuation">,</span>
                                                                      <span class="token class-name">String</span> password<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">IAuthenticationResult</span> result<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">SilentParameters</span> silentParameters <span class="token operator">=</span>
                    <span class="token class-name">SilentParameters</span>
                            <span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>scope<span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">account</span><span class="token punctuation">(</span>account<span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// Try to acquire token silently. This will fail on the first acquireTokenUsernamePassword() call</span>
            <span class="token comment">// because the token cache does not have any data for the user you are trying to acquire a token for</span>
            result <span class="token operator">=</span> pca<span class="token punctuation">.</span><span class="token function">acquireTokenSilently</span><span class="token punctuation">(</span>silentParameters<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;==acquireTokenSilently call succeeded&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ex<span class="token punctuation">.</span><span class="token function">getCause</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">instanceof</span> <span class="token class-name">MsalException</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;==acquireTokenSilently call failed: &quot;</span> <span class="token operator">+</span> ex<span class="token punctuation">.</span><span class="token function">getCause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">UserNamePasswordParameters</span> parameters <span class="token operator">=</span>
                        <span class="token class-name">UserNamePasswordParameters</span>
                                <span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>scope<span class="token punctuation">,</span> username<span class="token punctuation">,</span> password<span class="token punctuation">.</span><span class="token function">toCharArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// Try to acquire a token via username/password. If successful, you should see</span>
                <span class="token comment">// the token and account information printed out to console</span>
                result <span class="token operator">=</span> pca<span class="token punctuation">.</span><span class="token function">acquireToken</span><span class="token punctuation">(</span>parameters<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;==username/password flow succeeded&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// Handle other exceptions accordingly</span>
                <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Helper function to return an account from a given set of accounts based on the given username,
     * or return null if no accounts in the set match
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">IAccount</span> <span class="token function">getAccountByUsername</span><span class="token punctuation">(</span><span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">IAccount</span><span class="token punctuation">&gt;</span></span> accounts<span class="token punctuation">,</span> <span class="token class-name">String</span> username<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>accounts<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;==No accounts in cache&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;==Accounts in cache: &quot;</span> <span class="token operator">+</span> accounts<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">IAccount</span> account <span class="token operator">:</span> accounts<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>account<span class="token punctuation">.</span><span class="token function">username</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> account<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Helper function unique to this sample setting. In a real application these wouldn't be so hardcoded, for example
     * values such as username/password would come from the user, and different users may require different scopes
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">setUpSampleData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token comment">// Load properties file and set properties used throughout the sample</span>
        authority <span class="token operator">=</span> <span class="token class-name">ApplicationContextUtil</span><span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">&quot;office365.authority&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        scope <span class="token operator">=</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">singleton</span><span class="token punctuation">(</span><span class="token class-name">ApplicationContextUtil</span><span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">&quot;office365.scope&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        clientId <span class="token operator">=</span>  <span class="token class-name">ApplicationContextUtil</span><span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">&quot;office365.clientId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        username <span class="token operator">=</span> <span class="token class-name">ApplicationContextUtil</span><span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">&quot;office365.username&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        password <span class="token operator">=</span> <span class="token class-name">ApplicationContextUtil</span><span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">&quot;office365.password&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p>使用：</p> <div class="language-java extra-class"><pre class="language-java"><code>		<span class="token class-name">MsUserInfoDTO</span> me <span class="token operator">=</span> office365Client<span class="token punctuation">.</span><span class="token function">me</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">OfficeFolderDTO</span> folderDTO <span class="token operator">=</span> office365Client<span class="token punctuation">.</span><span class="token function">folders</span><span class="token punctuation">(</span>me<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">OfficeFolderDTO<span class="token punctuation">.</span>Folder</span> inboxFolder <span class="token operator">=</span> folderDTO<span class="token punctuation">.</span><span class="token function">getInboxFolder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">isNull</span><span class="token punctuation">(</span>inboxFolder<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">isNull</span><span class="token punctuation">(</span>inboxFolder<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                size <span class="token operator">+=</span> <span class="token number">10</span><span class="token punctuation">;</span>
                folderDTO <span class="token operator">=</span> office365Client<span class="token punctuation">.</span><span class="token function">folders</span><span class="token punctuation">(</span>me<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token comment">// 只读收件箱 Inbox 或者 收件箱</span>
                inboxFolder <span class="token operator">=</span> folderDTO<span class="token punctuation">.</span><span class="token function">getInboxFolder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
		<span class="token comment">// 收件箱id</span>
        <span class="token class-name">String</span> inboxFolderId <span class="token operator">=</span> inboxFolder<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> top <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> skip <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token class-name">EmailDTO</span> emailDTOS <span class="token operator">=</span> office365Client<span class="token punctuation">.</span><span class="token function">emails</span><span class="token punctuation">(</span>me<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> inboxFolderId<span class="token punctuation">,</span> top<span class="token punctuation">,</span> skip<span class="token punctuation">)</span><span class="token punctuation">;</span>


		<span class="token comment">// 所有未读消息</span>
		 <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">EmailDTO<span class="token punctuation">.</span>Value</span><span class="token punctuation">&gt;</span></span> collect <span class="token operator">=</span> emailDTOS<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token operator">::</span><span class="token function">nonNull</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">EmailDTO<span class="token punctuation">.</span>Value</span><span class="token operator">::</span><span class="token function">notRead</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		
		<span class="token comment">// 标记为已读</span>
		office365Client<span class="token punctuation">.</span><span class="token function">markAsRead</span><span class="token punctuation">(</span>me<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> inboxFolderId<span class="token punctuation">,</span> mail<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		
		<span class="token comment">// 中间省略 解析 下一条连接时，获取参数的过程，或者自己直接拼死每页10条，</span>
		<span class="token comment">// 当无数据时，默认不会返回这个key， 因此只要is null 就可以结束循环</span>
		
		 <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>emailDTOS <span class="token operator">=</span> office365Client<span class="token punctuation">.</span><span class="token function">emails</span><span class="token punctuation">(</span>me<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> inboxFolderId<span class="token punctuation">,</span> top<span class="token punctuation">,</span> skip<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> flag<span class="token punctuation">)</span><span class="token punctuation">;</span>
		 
		 <span class="token comment">// 我使用的是do while 循环.. 代码不全，只有大概的代码框架，</span>

</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/note/c++/" class="prev">
        C++ 继承
      </a></span> <span class="next"><a href="/note/toys/油猴脚本/B站视频下载.html">
        B站视频下载
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/note/assets/js/app.886f9803.js" defer></script><script src="/note/assets/js/2.94ba4297.js" defer></script><script src="/note/assets/js/1.b1c00c21.js" defer></script><script src="/note/assets/js/134.94a942ad.js" defer></script>
  </body>
</html>
